<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenTrack Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar for a cleaner look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Safe area for mobile bottom nav */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Game specific animations */
        @keyframes flash {
            0% { background-color: #6366f1; transform: scale(1); }
            50% { background-color: #a5b4fc; transform: scale(1.05); }
            100% { background-color: #6366f1; transform: scale(1); }
        }
        .animate-flash {
            animation: flash 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-[#f3f6f4] font-sans text-slate-800">
    <div id="root"></div>

    <!-- Main Script using ES Modules -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            CheckCircle, Plus, Calendar, TrendingUp, Activity, MoreHorizontal, 
            Leaf, Layout, Settings, Bell, Search, CheckSquare, X, User, 
            LogOut, ChevronRight, Clock, Play, Pause, RotateCcw, Timer, 
            FileText, Download, Upload, Save, Trash2, ArrowLeft, Edit3, 
            Image as ImageIcon, BarChart2, Quote, MoreVertical, Monitor, Zap, Coffee, Lock, Fingerprint, Key, BookOpen,
            Sparkles, Brain, MessageSquare, Gamepad2, Ghost, Puzzle, Trophy, Grid, Cpu, Crosshair, Award, Flame, Target,
            CalendarCheck, MapPin, Clock4, AlertTriangle, XCircle, UserX, GraduationCap
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        // --- Components ---

        // Simple Card Component
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-4 md:p-6 ${className}`}>
                {children}
            </div>
        );

        // Modal Component
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-all">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl transform transition-all scale-100 overflow-hidden animate-fadeIn">
                        <div className="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50/50">
                            <h3 className="text-lg font-bold text-[#1b4332]">{title}</h3>
                            <button 
                                onClick={onClose}
                                className="p-1 rounded-full hover:bg-slate-200 text-slate-400 transition-colors"
                            >
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // Progress Circle
        const ProgressCircle = ({ percentage, color = "#4ade80", size = 120, strokeWidth = 10 }) => {
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percentage / 100) * circumference;

            return (
                <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
                    <svg className="transform -rotate-90 w-full h-full">
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r={radius}
                            stroke="#f1f5f9"
                            strokeWidth={strokeWidth}
                            fill="transparent"
                        />
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r={radius}
                            stroke={color}
                            strokeWidth={strokeWidth}
                            fill="transparent"
                            strokeDasharray={circumference}
                            strokeDashoffset={offset}
                            strokeLinecap="round"
                            className="transition-all duration-1000 ease-out"
                        />
                    </svg>
                    <div className="absolute text-2xl font-bold text-slate-700">
                        {percentage}%
                    </div>
                </div>
            );
        };

        // Mini Sparkline
        const MiniSparkline = ({ data, color }) => {
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            const height = 40;
            const width = 100;
            
            const points = data.map((val, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((val - min) / range) * height;
                return `${x},${y}`;
            }).join(' ');

            return (
                <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="none">
                    <polyline
                        points={points}
                        fill="none"
                        stroke={color}
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                    />
                </svg>
            );
        };

        // Simple Bar Chart - FIXED: Default color uses Tailwind class instead of Hex
        const SimpleBarChart = ({ data, labels, color = "bg-emerald-500" }) => {
            const maxVal = Math.max(...data, 100); 

            return (
                <div className="w-full h-48 flex items-end justify-between gap-1 md:gap-2">
                    {data.map((val, i) => {
                        const barHeight = (val / maxVal) * 100;
                        return (
                            <div key={i} className="flex-1 flex flex-col items-center gap-2 group">
                                <div className="relative w-full flex items-end justify-center h-36 bg-slate-50 rounded-lg overflow-hidden">
                                    <div 
                                        style={{ height: `${barHeight}%` }} 
                                        className={`w-full mx-0.5 md:mx-1 rounded-t-md transition-all duration-500 ease-out opacity-80 group-hover:opacity-100 ${color}`}
                                    ></div>
                                    <div className="hidden md:block absolute -top-8 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                        {val}%
                                    </div>
                                </div>
                                <span className="text-[10px] md:text-xs text-slate-400 font-medium truncate w-full text-center">{labels[i]}</span>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- New Components ---

        // Class Schedule & Attendance Component
        const ClassSchedule = ({ schedule, setSchedule }) => {
            const [viewDay, setViewDay] = useState(new Date().toLocaleDateString('en-US', { weekday: 'long' }));
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            // Status Modal State
            const [selectedClass, setSelectedClass] = useState(null);
            
            const [newClass, setNewClass] = useState({ name: '', day: 'Monday', start: '', end: '', location: '' });

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            const getDaySchedule = () => {
                return schedule
                    .filter(s => s.day === viewDay)
                    .sort((a,b) => a.start.localeCompare(b.start));
            };

            const updateClassStatus = (id, status, reason = "") => {
                setSchedule(schedule.map(item => 
                    item.id === id ? { ...item, status: status, statusReason: reason } : item
                ));
                setSelectedClass(null); // Close modal
            };

            const handleAddClass = () => {
                if(newClass.name && newClass.start && newClass.end) {
                    setSchedule([...schedule, { ...newClass, id: Date.now(), status: 'pending' }]);
                    setIsAddModalOpen(false);
                    setNewClass({ ...newClass, name: '', start: '', end: '', location: '' }); 
                }
            };

            const deleteClass = (id) => {
                setSchedule(schedule.filter(s => s.id !== id));
                setSelectedClass(null);
            };

            // Helper to get color/icon based on status
            const getStatusConfig = (status) => {
                switch(status) {
                    case 'attended': return { color: 'bg-emerald-50 border-emerald-200', text: 'text-emerald-800', icon: <CheckCircle size={16}/>, label: 'Attended' };
                    case 'bunked': return { color: 'bg-red-50 border-red-200', text: 'text-red-800', icon: <XCircle size={16}/>, label: 'Bunked' };
                    case 'cancelled_teacher': return { color: 'bg-orange-50 border-orange-200', text: 'text-orange-800', icon: <AlertTriangle size={16}/>, label: 'Cancelled (Teacher)' };
                    case 'cancelled_student': return { color: 'bg-yellow-50 border-yellow-200', text: 'text-yellow-800', icon: <UserX size={16}/>, label: 'Skipped (Personal)' };
                    default: return { color: 'bg-white border-slate-100 hover:border-indigo-200', text: 'text-slate-800', icon: null, label: '' };
                }
            };

            return (
                <div className="space-y-6 h-full flex flex-col animate-fadeIn">
                    <div className="flex items-center justify-between">
                        <h2 className="text-xl md:text-2xl font-bold text-[var(--primary)] flex items-center gap-2">
                            <CalendarCheck size={24} /> Class Schedule
                        </h2>
                        <button onClick={() => setIsAddModalOpen(true)} className="flex items-center gap-2 bg-[var(--primary)] text-white px-3 py-2 rounded-xl hover:bg-[var(--secondary)] transition-colors text-sm font-medium">
                            <Plus size={18} /> Add Class
                        </button>
                    </div>

                    {/* Day Selector */}
                    <div className="flex overflow-x-auto gap-2 pb-2 custom-scrollbar">
                        {days.map(day => (
                            <button 
                                key={day}
                                onClick={() => setViewDay(day)}
                                className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
                                    viewDay === day 
                                    ? 'bg-slate-800 text-white shadow-md' 
                                    : 'bg-white text-slate-500 border border-slate-200 hover:bg-slate-50'
                                }`}
                            >
                                {day}
                            </button>
                        ))}
                    </div>

                    {/* Timeline View */}
                    <div className="flex-1 overflow-y-auto custom-scrollbar pb-20">
                        {getDaySchedule().length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-64 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
                                <Calendar size={48} className="mb-4 opacity-50"/>
                                <p>No classes scheduled for {viewDay}.</p>
                                <button onClick={() => { setNewClass({...newClass, day: viewDay}); setIsAddModalOpen(true); }} className="mt-4 text-indigo-600 font-medium hover:underline">Add one now</button>
                            </div>
                        ) : (
                            <div className="space-y-4 relative">
                                {/* Vertical Line */}
                                <div className="absolute left-6 top-4 bottom-4 w-0.5 bg-slate-200 z-0"></div>
                                
                                {getDaySchedule().map((item) => {
                                    const statusConfig = getStatusConfig(item.status);
                                    return (
                                        <div key={item.id} className="relative z-10 flex gap-4">
                                            <div className="flex flex-col items-center pt-1 min-w-[50px]">
                                                <div className="text-xs font-bold text-slate-500 mb-1">{item.start}</div>
                                                <div className={`w-3 h-3 rounded-full border-2 ${item.status === 'pending' ? 'bg-white border-slate-300' : 'bg-slate-800 border-slate-800'}`}></div>
                                                <div className="text-xs text-slate-400 mt-1">{item.end}</div>
                                            </div>
                                            
                                            <Card className={`flex-1 transition-all cursor-pointer ${statusConfig.color}`} >
                                                <div onClick={() => setSelectedClass(item)} className="w-full">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h3 className={`font-bold text-lg ${statusConfig.text}`}>{item.name}</h3>
                                                            <div className="flex items-center gap-4 mt-2 text-sm text-slate-500">
                                                                <span className="flex items-center gap-1"><MapPin size={14}/> {item.location || 'No Location'}</span>
                                                                <span className="flex items-center gap-1"><Clock4 size={14}/> {item.start} - {item.end}</span>
                                                            </div>
                                                        </div>
                                                        {item.status !== 'pending' && (
                                                            <span className={`text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1 bg-white/50 border border-black/5 ${statusConfig.text}`}>
                                                                {statusConfig.icon} {statusConfig.label}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </Card>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Status Update Modal */}
                    <Modal isOpen={!!selectedClass} onClose={() => setSelectedClass(null)} title="Update Class Status">
                        {selectedClass && (
                            <div className="space-y-4">
                                <div className="text-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800">{selectedClass.name}</h3>
                                    <p className="text-slate-500">{selectedClass.start} - {selectedClass.end} • {selectedClass.location}</p>
                                </div>

                                <div className="grid grid-cols-1 gap-3">
                                    <button onClick={() => updateClassStatus(selectedClass.id, 'attended')} className="flex items-center gap-3 p-4 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 hover:bg-emerald-100 transition-colors">
                                        <div className="p-2 bg-emerald-200 rounded-full"><CheckCircle size={20}/></div>
                                        <div className="text-left">
                                            <p className="font-bold">Attended</p>
                                            <p className="text-xs opacity-80">I was present in class.</p>
                                        </div>
                                    </button>

                                    <button onClick={() => updateClassStatus(selectedClass.id, 'cancelled_teacher')} className="flex items-center gap-3 p-4 rounded-xl border border-orange-200 bg-orange-50 text-orange-800 hover:bg-orange-100 transition-colors">
                                        <div className="p-2 bg-orange-200 rounded-full"><AlertTriangle size={20}/></div>
                                        <div className="text-left">
                                            <p className="font-bold">Cancelled by Teacher</p>
                                            <p className="text-xs opacity-80">Class was called off.</p>
                                        </div>
                                    </button>

                                    <button onClick={() => updateClassStatus(selectedClass.id, 'cancelled_student')} className="flex items-center gap-3 p-4 rounded-xl border border-yellow-200 bg-yellow-50 text-yellow-800 hover:bg-yellow-100 transition-colors">
                                        <div className="p-2 bg-yellow-200 rounded-full"><UserX size={20}/></div>
                                        <div className="text-left">
                                            <p className="font-bold">Cancelled by Me</p>
                                            <p className="text-xs opacity-80">Personal reason / Sick leave.</p>
                                        </div>
                                    </button>

                                    <button onClick={() => updateClassStatus(selectedClass.id, 'bunked')} className="flex items-center gap-3 p-4 rounded-xl border border-red-200 bg-red-50 text-red-800 hover:bg-red-100 transition-colors">
                                        <div className="p-2 bg-red-200 rounded-full"><XCircle size={20}/></div>
                                        <div className="text-left">
                                            <p className="font-bold">Bunked</p>
                                            <p className="text-xs opacity-80">Skipped for fun/other reasons.</p>
                                        </div>
                                    </button>
                                </div>

                                <div className="pt-4 border-t border-slate-100 mt-2">
                                    <button onClick={() => deleteClass(selectedClass.id)} className="w-full text-red-500 text-sm hover:underline">Delete this class entry</button>
                                </div>
                            </div>
                        )}
                    </Modal>

                    {/* Add Class Modal */}
                    <Modal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} title="Add Schedule Entry">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Class / Activity Name</label>
                                <input 
                                    type="text" 
                                    placeholder="e.g. Data Structures" 
                                    value={newClass.name} 
                                    onChange={(e) => setNewClass({...newClass, name: e.target.value})} 
                                    className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Day</label>
                                <select 
                                    value={newClass.day} 
                                    onChange={(e) => setNewClass({...newClass, day: e.target.value})}
                                    className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 bg-white"
                                >
                                    {days.map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Start Time</label>
                                    <input 
                                        type="time" 
                                        value={newClass.start} 
                                        onChange={(e) => setNewClass({...newClass, start: e.target.value})} 
                                        className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">End Time</label>
                                    <input 
                                        type="time" 
                                        value={newClass.end} 
                                        onChange={(e) => setNewClass({...newClass, end: e.target.value})} 
                                        className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Location (Where am I?)</label>
                                <input 
                                    type="text" 
                                    placeholder="e.g. Room 304 or Library" 
                                    value={newClass.location} 
                                    onChange={(e) => setNewClass({...newClass, location: e.target.value})} 
                                    className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"
                                />
                            </div>

                            <button onClick={handleAddClass} className="w-full bg-[var(--primary)] text-white py-3 rounded-xl font-bold hover:bg-[var(--secondary)] transition-all mt-4 shadow-lg">
                                Add to Schedule
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // Hard Memory Game 1: Neural Grid (Icons)
        const NeuralGridGame = () => {
            // 5x4 grid = 20 cards = 10 pairs. Harder than standard.
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [solved, setSolved] = useState([]);
            const [disabled, setDisabled] = useState(false);
            const [moves, setMoves] = useState(0);
            const [timeLeft, setTimeLeft] = useState(45); // 45s hard limit
            const [gameState, setGameState] = useState('idle'); // idle, playing, won, lost

            // Icons that look somewhat similar to increase difficulty
            const icons = [
                { id: '1', icon: ArrowLeft, rotate: 0 },
                { id: '2', icon: ArrowLeft, rotate: 90 },
                { id: '3', icon: ArrowLeft, rotate: 180 },
                { id: '4', icon: ArrowLeft, rotate: 270 }, // Directional confusion
                { id: '5', icon: Target },
                { id: '6', icon: Crosshair }, // Similar shapes
                { id: '7', icon: Zap },
                { id: '8', icon: Activity }, // Jagged lines
                { id: '9', icon: Lock },
                { id: '10', icon: Key },
            ];

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                } else if (timeLeft === 0 && gameState === 'playing') {
                    setGameState('lost');
                }
                return () => clearInterval(timer);
            }, [gameState, timeLeft]);

            const startGame = () => {
                const deck = [...icons, ...icons]
                    .sort(() => Math.random() - 0.5)
                    .map((item, index) => ({ ...item, uniqueId: index }));
                
                setCards(deck);
                setFlipped([]);
                setSolved([]);
                setMoves(0);
                setTimeLeft(45);
                setDisabled(false);
                setGameState('playing');
            };

            const handleCardClick = (id) => {
                if (disabled || gameState !== 'playing' || flipped.includes(id) || solved.includes(id)) return;

                if (flipped.length === 0) {
                    setFlipped([id]);
                    return;
                }

                if (flipped.length === 1) {
                    setDisabled(true);
                    setFlipped([...flipped, id]);
                    setMoves(m => m + 1);

                    const firstCard = cards.find(c => c.uniqueId === flipped[0]);
                    const secondCard = cards.find(c => c.uniqueId === id);

                    if (firstCard.id === secondCard.id) {
                        setSolved(prev => [...prev, firstCard.uniqueId, secondCard.uniqueId]);
                        setFlipped([]);
                        setDisabled(false);
                        if (solved.length + 2 === cards.length) setGameState('won');
                    } else {
                        setTimeout(() => {
                            setFlipped([]);
                            setDisabled(false);
                        }, 800); // Fast flip back for "hard" feel
                    }
                }
            };

            return (
                <div className="bg-slate-900 rounded-2xl p-6 text-white shadow-xl border border-slate-700 relative overflow-hidden">
                    {/* Styling elements */}
                    <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                    
                    <div className="flex justify-between items-center mb-6 relative z-10">
                        <div>
                            <h3 className="text-xl font-bold flex items-center gap-2 text-purple-400">
                                <Brain size={24} /> Neural Grid
                            </h3>
                            <p className="text-xs text-slate-400">Hard • 45s Timer • Directional</p>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className={`font-mono text-xl font-bold ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-slate-200'}`}>
                                00:{timeLeft.toString().padStart(2, '0')}
                            </div>
                            <button onClick={startGame} className="bg-purple-600 hover:bg-purple-500 text-white px-4 py-1.5 rounded-lg text-sm font-bold transition-all">
                                {gameState === 'idle' ? 'Start' : 'Reset'}
                            </button>
                        </div>
                    </div>

                    {gameState === 'idle' ? (
                        <div className="h-64 flex flex-col items-center justify-center text-slate-400 bg-slate-800/50 rounded-xl border border-slate-700 border-dashed">
                            <Brain size={48} className="mb-4 opacity-50" />
                            <p>Press Start to begin memory training.</p>
                        </div>
                    ) : gameState === 'lost' ? (
                        <div className="h-64 flex flex-col items-center justify-center text-red-400 bg-slate-800/50 rounded-xl border border-red-900/30">
                            <X size={48} className="mb-4" />
                            <p className="font-bold text-lg">Time's Up!</p>
                            <p className="text-sm">Neural link failed.</p>
                            <button onClick={startGame} className="mt-4 text-white underline">Try Again</button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-5 gap-2 md:gap-3">
                            {cards.map(card => {
                                const isFlipped = flipped.includes(card.uniqueId) || solved.includes(card.uniqueId);
                                return (
                                    <button
                                        key={card.uniqueId}
                                        onClick={() => handleCardClick(card.uniqueId)}
                                        className={`aspect-square rounded-lg transition-all duration-300 transform relative ${
                                            isFlipped ? 'bg-purple-600 rotate-y-180' : 'bg-slate-700 hover:bg-slate-600'
                                        }`}
                                    >
                                        {isFlipped && (
                                            <div className="absolute inset-0 flex items-center justify-center">
                                                <card.icon 
                                                    size={20} 
                                                    className="text-white" 
                                                    style={{ transform: `rotate(${card.rotate}deg)` }} 
                                                />
                                            </div>
                                        )}
                                        {!isFlipped && (
                                            <div className="absolute inset-0 flex items-center justify-center opacity-10">
                                                <Brain size={16} />
                                            </div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    )}
                    {gameState === 'won' && (
                        <div className="absolute inset-0 bg-slate-900/90 flex flex-col items-center justify-center z-20 animate-fadeIn">
                            <Trophy size={64} className="text-yellow-400 mb-4 animate-bounce" />
                            <h2 className="text-3xl font-bold text-white mb-2">Neural Link Established!</h2>
                            <p className="text-slate-300">Moves: {moves} | Time: {45 - timeLeft}s</p>
                            <button onClick={startGame} className="mt-6 bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-2 rounded-full font-bold shadow-lg shadow-emerald-500/20">Play Again</button>
                        </div>
                    )}
                </div>
            );
        };

        // Hard Memory Game 2: Pattern Echo (Sequence)
        const PatternEchoGame = () => {
            const [sequence, setSequence] = useState([]);
            const [playerSequence, setPlayerSequence] = useState([]);
            const [isPlayingSequence, setIsPlayingSequence] = useState(false);
            const [score, setScore] = useState(0);
            const [highScore, setHighScore] = useState(0);
            const [activeTile, setActiveTile] = useState(null);
            const [gameOver, setGameOver] = useState(false);
            const [gameActive, setGameActive] = useState(false);

            // 3x3 Grid = 9 tiles
            const tiles = [0, 1, 2, 3, 4, 5, 6, 7, 8];

            const startGame = () => {
                setSequence([]);
                setPlayerSequence([]);
                setScore(0);
                setGameOver(false);
                setGameActive(true);
                addToSequence([]); // Start with empty array passed to helper
            };

            const addToSequence = async (currentSeq) => {
                const nextTile = Math.floor(Math.random() * 9);
                const newSeq = [...currentSeq, nextTile];
                setSequence(newSeq);
                setPlayerSequence([]);
                setIsPlayingSequence(true);

                // Delay before playing
                await new Promise(r => setTimeout(r, 800));

                // Play sequence
                for (let i = 0; i < newSeq.length; i++) {
                    setActiveTile(newSeq[i]);
                    await new Promise(r => setTimeout(r, 400)); // Light up duration
                    setActiveTile(null);
                    await new Promise(r => setTimeout(r, 200)); // Gap
                }
                setIsPlayingSequence(false);
            };

            const handleTileClick = (index) => {
                if (!gameActive || isPlayingSequence || gameOver) return;

                // Flash click
                setActiveTile(index);
                setTimeout(() => setActiveTile(null), 200);

                const currentMove = playerSequence.length;
                if (index !== sequence[currentMove]) {
                    // Wrong move
                    setGameOver(true);
                    setGameActive(false);
                    if (score > highScore) setHighScore(score);
                    return;
                }

                const newPlayerSeq = [...playerSequence, index];
                setPlayerSequence(newPlayerSeq);

                if (newPlayerSeq.length === sequence.length) {
                    // Level Complete
                    setScore(s => s + 1);
                    setTimeout(() => addToSequence(sequence), 1000);
                }
            };

            return (
                <div className="bg-slate-900 rounded-2xl p-6 text-white shadow-xl border border-slate-700 relative">
                     <div className="absolute top-0 left-0 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl -ml-16 -mt-16 pointer-events-none"></div>
                    
                    <div className="flex justify-between items-start mb-6 relative z-10">
                        <div>
                            <h3 className="text-xl font-bold flex items-center gap-2 text-cyan-400">
                                <Grid size={24} /> Pattern Echo
                            </h3>
                            <p className="text-xs text-slate-400">Hard • Sequence Recall</p>
                        </div>
                        <div className="text-right">
                            <p className="text-xs text-slate-400 uppercase">Score</p>
                            <p className="text-2xl font-mono font-bold text-cyan-400">{score}</p>
                        </div>
                    </div>

                    <div className="flex justify-center mb-6">
                        <div className="grid grid-cols-3 gap-3">
                            {tiles.map(i => (
                                <button
                                    key={i}
                                    onClick={() => handleTileClick(i)}
                                    className={`w-20 h-20 rounded-xl border-2 transition-all duration-150 ${
                                        activeTile === i 
                                            ? 'bg-cyan-400 border-cyan-200 shadow-[0_0_20px_rgba(34,211,238,0.6)] scale-95' 
                                            : 'bg-slate-800 border-slate-700 hover:border-slate-600'
                                    } ${gameOver ? 'opacity-50 cursor-not-allowed' : ''}`}
                                ></button>
                            ))}
                        </div>
                    </div>

                    {!gameActive && !gameOver && (
                        <div className="absolute inset-0 bg-slate-900/80 flex items-center justify-center rounded-2xl z-20">
                            <button onClick={startGame} className="bg-cyan-500 hover:bg-cyan-400 text-slate-900 px-8 py-3 rounded-xl font-bold text-lg transition-all shadow-lg hover:scale-105">
                                Start Pattern
                            </button>
                        </div>
                    )}

                    {gameOver && (
                        <div className="absolute inset-0 bg-slate-900/90 flex flex-col items-center justify-center rounded-2xl z-20 animate-fadeIn">
                            <div className="text-red-500 font-bold text-2xl mb-2">Sequence Broken</div>
                            <div className="text-slate-300 mb-6">Final Score: {score}</div>
                            <button onClick={startGame} className="bg-white text-slate-900 px-6 py-2 rounded-lg font-bold hover:bg-slate-200 transition-all">Try Again</button>
                        </div>
                    )}
                </div>
            );
        };

        // Updated Analysis Component
        const MemoryAnalysis = () => {
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Cpu size={20} className="text-indigo-500"/> Cognitive Stats</h3>
                            <div className="space-y-6">
                                <div>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="text-slate-600">Visual Recall</span>
                                        <span className="font-bold text-purple-600">Top 15%</span>
                                    </div>
                                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                        <div className="h-full bg-purple-500 w-[85%]"></div>
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="text-slate-600">Pattern Recognition</span>
                                        <span className="font-bold text-cyan-600">Level 8</span>
                                    </div>
                                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                        <div className="h-full bg-cyan-500 w-[72%]"></div>
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="text-slate-600">Reaction Speed</span>
                                        <span className="font-bold text-amber-600">420ms</span>
                                    </div>
                                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                        <div className="h-full bg-amber-500 w-[65%]"></div>
                                    </div>
                                </div>
                            </div>
                        </Card>

                        <Card>
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><TrendingUp size={20} className="text-emerald-500"/> Performance History</h3>
                            <SimpleBarChart data={[45, 60, 55, 75, 80, 85, 82]} labels={['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']} color="bg-emerald-400" />
                            <p className="text-xs text-slate-400 text-center mt-4">Average score across all memory modules.</p>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- Main Application ---

        function App() {
            // State Definitions
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isProfileOpen, setIsProfileOpen] = useState(false);
            const [isDesktopProfileOpen, setIsDesktopProfileOpen] = useState(false);
            const [isSettingsHovered, setIsSettingsHovered] = useState(false);
            const [isEditProfileModalOpen, setIsEditProfileModalOpen] = useState(false);
            const [isAIPlanModalOpen, setIsAIPlanModalOpen] = useState(false);
            const [aiGoal, setAiGoal] = useState('');
            const [isAILoading, setIsAILoading] = useState(false);
            const [isQuizModalOpen, setIsQuizModalOpen] = useState(false);
            const [quizContent, setQuizContent] = useState(null);
            
            // Schedule State (Lifted from ClassSchedule)
            const [schedule, setSchedule] = useState([
                { id: 1, name: "Calculus II", day: "Monday", start: "09:00", end: "10:30", location: "Science Hall 304", status: 'pending' },
                { id: 2, name: "Physics Lab", day: "Monday", start: "13:00", end: "15:00", location: "Lab Block B", status: 'pending' },
                { id: 3, name: "Library Study", day: "Tuesday", start: "10:00", end: "12:00", location: "Main Library", status: 'attended' },
                { id: 4, name: "Data Structures", day: new Date().toLocaleDateString('en-US', { weekday: 'long' }), start: "14:00", end: "16:00", location: "Tech Wing 202", status: 'pending' },
            ]);

            const [studyCourse, setStudyCourse] = useState('Web Development');

            const [profileData, setProfileData] = useState({
                name: 'Prashant Jangra',
                email: 'prashant@example.com',
                bio: 'Productivity Enthusiast'
            });
            
            const [appTheme, setAppTheme] = useState('light');
            const [currentTheme, setCurrentTheme] = useState('default');
            const [securitySettings, setSecuritySettings] = useState({
                appLock: false,
                biometric: false
            });
            const [isNavVisible, setIsNavVisible] = useState(true);
            const [isMoreMenuOpen, setIsMoreMenuOpen] = useState(false);
            const [isNotificationsOpen, setIsNotificationsOpen] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [profileImage, setProfileImage] = useState(null);
            const [isHabitModalOpen, setIsHabitModalOpen] = useState(false);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            
            // Focus Mode States
            const [focusType, setFocusType] = useState('timer');
            const [timerTime, setTimerTime] = useState(25 * 60);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [timerDuration, setTimerDuration] = useState(25 * 60);
            const [stopwatchTime, setStopwatchTime] = useState(0);
            const [isStopwatchRunning, setIsStopwatchRunning] = useState(false);
            const [simulatorHour, setSimulatorHour] = useState(22);
            
            const [focusMode, setFocusMode] = useState('light'); 
            const [focusTask, setFocusTask] = useState('Deep Work Session');
            const [scratchpad, setScratchpad] = useState('');
            const [parkingLot, setParkingLot] = useState('');
            const [isParkingLotOpen, setIsParkingLotOpen] = useState(false);
            const [sessionComplete, setSessionComplete] = useState(false);
            const [sessionDepth, setSessionDepth] = useState(50);
            const [totalFocusTime, setTotalFocusTime] = useState(0);

            // Analysis
            const [analysisView, setAnalysisView] = useState('weekly');

            // Notes
            const [notesView, setNotesView] = useState('list');
            const [activeNote, setActiveNote] = useState(null);
            const [notes, setNotes] = useState([
                { id: 1, title: '2026 Resolutions Idea', content: 'Focus on mindfulness and gardening more often.', category: 'Journal', date: 'Oct 25, 2025' },
                { id: 2, title: 'Garden Layout', content: 'Need to buy more Hydrangeas for the north side.', category: 'Ideas', date: 'Oct 24, 2025' }
            ]);
            const [noteForm, setNoteForm] = useState({ title: '', content: '', category: 'Journal' });

            // Form Data
            const [newHabit, setNewHabit] = useState({ name: '', category: 'Health' });
            const [newTask, setNewTask] = useState({ title: '', priority: 'Medium', due: 'Today' });

            // Mock Data
            const [habits, setHabits] = useState([
                { id: 1, name: 'Morning Meditation', streak: 12, completedToday: true, category: 'Mind', color: 'bg-indigo-200 text-indigo-800' },
                { id: 2, name: 'Forest Walk', streak: 5, completedToday: false, category: 'Body', color: 'bg-emerald-200 text-emerald-800' },
                { id: 3, name: 'Read 30 Mins', streak: 24, completedToday: false, category: 'Growth', color: 'bg-fuchsia-200 text-fuchsia-800' },
                { id: 4, name: 'Drink 2L Water', streak: 8, completedToday: true, category: 'Health', color: 'bg-cyan-200 text-cyan-800' },
            ]);

            const [tasks, setTasks] = useState([
                { id: 1, title: '2026 Vision Board', priority: 'High', due: '2:00 PM', completed: false, tag: 'Work' },
                { id: 2, title: 'Plant new hydrangeas', priority: 'Medium', due: '5:00 PM', completed: false, tag: 'Personal' },
                { id: 3, title: 'Call Insurance', priority: 'Low', due: 'Tomorrow', completed: true, tag: 'Admin' },
            ]);

            const [currentDate, setCurrentDate] = useState(new Date());

            // Refs
            const lastScrollY = useRef(0);
            const scrollContainerRef = useRef(null);
            const notificationRef = useRef(null);
            const desktopProfileRef = useRef(null);
            const mobileProfileRef = useRef(null);
            const moreMenuRef = useRef(null);
            const moreBtnRef = useRef(null);
            const fileInputRef = useRef(null);

            // Course Data Dictionary
            const courseData = {
                'NDA': {
                    color: 'orange',
                    subjects: ['Mathematics', 'General Ability', 'English', 'Current Affairs'],
                    goals: [
                        { text: 'Solve 30 Calculus Problems', progress: 0 },
                        { text: 'Read Daily News Editorial', progress: 0 },
                        { text: 'Physical Training: 5km Run', progress: 0 }
                    ]
                },
                'Chess Learning': {
                    color: 'indigo',
                    subjects: ['Opening Theory', 'Tactics & Puzzles', 'Endgames', 'Grandmaster Analysis'],
                    goals: [
                        { text: 'Complete 25 Puzzle Rush', progress: 0 },
                        { text: 'Analyze one Magnus Carlsen game', progress: 0 },
                        { text: 'Learn the London System', progress: 0 }
                    ]
                },
                'Web Development': {
                    color: 'emerald',
                    subjects: ['React.js', 'Tailwind CSS', 'Node.js', 'System Design'],
                    goals: [
                        { text: 'Build a Navbar Component', progress: 0 },
                        { text: 'Learn React Hooks (useEffect)', progress: 0 },
                        { text: 'Deploy to Vercel', progress: 0 }
                    ]
                }
            };

            const themes = {
                default: { name: 'Zen Green', colors: { primary: '#1b4332', secondary: '#2d6a4f', accent: '#40916c', bg: '#f3f6f4', sidebarBottom: '#153628' } },
                ocean: { name: 'Ocean Blue', colors: { primary: '#1e3a8a', secondary: '#1e40af', accent: '#3b82f6', bg: '#eff6ff', sidebarBottom: '#172554' } },
                sunset: { name: 'Sunset Orange', colors: { primary: '#9a3412', secondary: '#c2410c', accent: '#f97316', bg: '#fff7ed', sidebarBottom: '#7c2d12' } },
                berry: { name: 'Berry Pink', colors: { primary: '#831843', secondary: '#9d174d', accent: '#ec4899', bg: '#fdf2f8', sidebarBottom: '#500724' } },
                royal: { name: 'Royal Purple', colors: { primary: '#4c1d95', secondary: '#6d28d9', accent: '#8b5cf6', bg: '#f5f3ff', sidebarBottom: '#2e1065' } },
                teal: { name: 'Fresh Teal', colors: { primary: '#134e4a', secondary: '#0f766e', accent: '#14b8a6', bg: '#f0fdfa', sidebarBottom: '#115e59' } }
            };

            // Mock Screen Time Data
            const screenTimeData = {
                total: 385, // 6h 25m
                productive: 260,
                distraction: 125,
                switches: 42,
                hygiene: 78,
                apps: [
                    { name: 'VS Code', time: 180, type: 'productive', icon: '💻' },
                    { name: 'Chrome (Work)', time: 80, type: 'productive', icon: '🌐' },
                    { name: 'Slack', time: 45, type: 'communication', icon: '#️⃣' },
                    { name: 'YouTube', time: 60, type: 'distraction', icon: '▶️' },
                    { name: 'Instagram', time: 20, type: 'distraction', icon: '📸' },
                ]
            };

            // --- Effects ---
            
            // Timer Logic
            useEffect(() => {
                let interval = null;
                if (isTimerRunning && timerTime > 0) {
                    interval = setInterval(() => setTimerTime(t => t - 1), 1000);
                } else if (timerTime === 0 && isTimerRunning) {
                    setIsTimerRunning(false);
                    setTotalFocusTime(prev => prev + timerDuration);
                    setTimerTime(timerDuration);
                }
                return () => clearInterval(interval);
            }, [isTimerRunning, timerTime, timerDuration]);

            // Stopwatch Logic
            useEffect(() => {
                let interval = null;
                if (isStopwatchRunning) {
                    interval = setInterval(() => setStopwatchTime(t => t + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [isStopwatchRunning]);

            // Date Clock
            useEffect(() => {
                const timer = setInterval(() => setCurrentDate(new Date()), 60000);
                return () => clearInterval(timer);
            }, []);

            // Search Logic
            useEffect(() => {
                if (!searchQuery) {
                    setSearchResults([]);
                    return;
                }
                const lowerQuery = searchQuery.toLowerCase();
                const matchedTasks = tasks.filter(t => t.title.toLowerCase().includes(lowerQuery)).map(t => ({...t, type: 'task'}));
                const matchedHabits = habits.filter(h => h.name.toLowerCase().includes(lowerQuery)).map(h => ({...h, type: 'habit'}));
                setSearchResults([...matchedTasks, ...matchedHabits]);
            }, [searchQuery, tasks, habits]);

            // Click Outside Handler for Notifications
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                        setIsNotificationsOpen(false);
                    }
                    if (desktopProfileRef.current && !desktopProfileRef.current.contains(event.target)) {
                        setIsDesktopProfileOpen(false);
                    }
                    if (mobileProfileRef.current && !mobileProfileRef.current.contains(event.target)) {
                        setIsProfileOpen(false);
                    }
                    if (moreMenuRef.current && !moreMenuRef.current.contains(event.target) && (!moreBtnRef.current || !moreBtnRef.current.contains(event.target))) {
                        setIsMoreMenuOpen(false);
                    }
                };
                if (isNotificationsOpen || isDesktopProfileOpen || isProfileOpen || isMoreMenuOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [isNotificationsOpen, isDesktopProfileOpen, isProfileOpen, isMoreMenuOpen]);

            // Theme Application
            useEffect(() => {
                const theme = themes[currentTheme];
                const root = document.documentElement;
                root.style.setProperty('--primary', theme.colors.primary);
                root.style.setProperty('--secondary', theme.colors.secondary);
                root.style.setProperty('--accent', theme.colors.accent);
                root.style.setProperty('--bg-main', theme.colors.bg);
                root.style.setProperty('--sidebar-bottom', theme.colors.sidebarBottom);
                document.body.style.backgroundColor = theme.colors.bg;
            }, [currentTheme]);

            // Scroll Handler
            useEffect(() => {
                const handleScroll = () => {
                    if (scrollContainerRef.current) {
                        const currentScrollY = scrollContainerRef.current.scrollTop;
                        const threshold = 10;
                        if (Math.abs(currentScrollY - lastScrollY.current) > threshold) {
                            if (currentScrollY > lastScrollY.current && currentScrollY > 20) {
                                setIsNavVisible(false);
                            } else {
                                setIsNavVisible(true);
                            }
                            lastScrollY.current = currentScrollY;
                        }
                    }
                };
                const container = scrollContainerRef.current;
                if (container) {
                    container.addEventListener('scroll', handleScroll);
                    return () => container.removeEventListener('scroll', handleScroll);
                }
            }, []);

            // --- Helpers ---
            const formatTime = (seconds) => {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            const toggleHabit = (id) => {
                setHabits(habits.map(h => h.id === id ? { ...h, completedToday: !h.completedToday } : h));
            };

            const toggleTask = (id) => {
                setTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            };

            const addHabit = () => {
                if (!newHabit.name) return;
                let color = 'bg-slate-200 text-slate-800';
                if (newHabit.category === 'Mind') color = 'bg-indigo-200 text-indigo-800';
                if (newHabit.category === 'Body') color = 'bg-emerald-200 text-emerald-800';
                if (newHabit.category === 'Growth') color = 'bg-fuchsia-200 text-fuchsia-800';
                if (newHabit.category === 'Health') color = 'bg-cyan-200 text-cyan-800';

                setHabits([...habits, {
                    id: Date.now(),
                    name: newHabit.name,
                    streak: 0,
                    completedToday: false,
                    category: newHabit.category,
                    color: color
                }]);
                setNewHabit({ name: '', category: 'Health' });
                setIsHabitModalOpen(false);
            };

            const addTask = () => {
                if (!newTask.title) return;
                setTasks([...tasks, {
                    id: Date.now(),
                    title: newTask.title,
                    priority: newTask.priority,
                    due: newTask.due,
                    completed: false,
                    tag: 'General'
                }]);
                setNewTask({ title: '', priority: 'Medium', due: 'Today' });
                setIsTaskModalOpen(false);
            };

            const handleSaveNote = () => {
                if (!noteForm.title) return;
                if (activeNote) {
                    setNotes(notes.map(n => n.id === activeNote.id ? { ...n, ...noteForm, date: 'Edited just now' } : n));
                } else {
                    setNotes([...notes, {
                        id: Date.now(),
                        ...noteForm,
                        date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    }]);
                }
                setNotesView('list');
                setActiveNote(null);
                setNoteForm({ title: '', content: '', category: 'Journal' });
            };

            const handleDeleteNote = (id) => {
                setNotes(notes.filter(n => n.id !== id));
                if (activeNote && activeNote.id === id) {
                    setNotesView('list');
                    setActiveNote(null);
                }
            };

            const openNoteEditor = (note = null) => {
                if (note) {
                    setActiveNote(note);
                    setNoteForm({ title: note.title, content: note.content, category: note.category });
                } else {
                    setActiveNote(null);
                    setNoteForm({ title: '', content: '', category: 'Journal' });
                }
                setNotesView('edit');
            };

            const handleExport = () => {
                const data = JSON.stringify({ habits, tasks, notes }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'zentrack_data.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImport = () => {
                alert("Import feature ready! This would connect to your backend.");
            };

            const handleAddImage = () => {
                alert("Image upload placeholder.");
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setProfileImage(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Helper to get next class for Dashboard
            const getNextClass = () => {
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                const todayClasses = schedule.filter(s => s.day === today);
                // Find first class that hasn't ended or started yet (simplified logic)
                const upcoming = todayClasses
                    .filter(s => s.start > currentTime)
                    .sort((a, b) => a.start.localeCompare(b.start));
                
                return upcoming.length > 0 ? upcoming[0] : null;
            };

            // Gemini API Helper
            const callGemini = async (prompt, systemInstruction = "") => {
                const apiKey = ""; // API Key provided by environment
                if (!apiKey) {
                    console.warn("API Key missing");
                    return "Simulation: AI response requires a valid API key in the environment.";
                }
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                let retries = 0;
                const maxRetries = 3;
                const baseDelay = 1000;

                while (retries <= maxRetries) {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }]
                        };
                        
                        if (systemInstruction) {
                            payload.systemInstruction = { parts: [{ text: systemInstruction }] };
                        }

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`API Error: ${response.status}`);

                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                    } catch (error) {
                        retries++;
                        if (retries > maxRetries) return "Error connecting to AI. Please try again.";
                        await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, retries - 1)));
                    }
                }
            };

            // AI Features
            const handleSmartPlan = async () => {
                if (!aiGoal.trim()) return;
                setIsAILoading(true);
                
                const prompt = `I have a goal: "${aiGoal}". Break this down into 3 to 5 concise, actionable tasks. Return strictly a JSON array of strings (e.g., ["Task 1", "Task 2"]). Do not include markdown formatting or extra text.`;
                
                try {
                    const response = await callGemini(prompt);
                    const cleanResponse = response.replace(/```json|```/g, '').trim();
                    const newTasks = JSON.parse(cleanResponse);
                    
                    if (Array.isArray(newTasks)) {
                        const tasksToAdd = newTasks.map(title => ({
                            id: Date.now() + Math.random(),
                            title: title,
                            priority: 'Medium',
                            due: 'This Week',
                            completed: false,
                            tag: 'AI Plan'
                        }));
                        setTasks(prev => [...prev, ...tasksToAdd]);
                        setIsAIPlanModalOpen(false);
                        setAiGoal('');
                    } else {
                        alert("AI couldn't generate a plan. Try a clearer goal.");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Failed to parse AI plan.");
                } finally {
                    setIsAILoading(false);
                }
            };

            const handleQuizMe = async (subject) => {
                setIsQuizModalOpen(true);
                setQuizContent({ loading: true });
                
                const prompt = `Generate a challenging multiple-choice question about ${subject}. 
                Format:
                Question: [Question text]
                A) [Option A]
                B) [Option B]
                C) [Option C]
                D) [Option D]
                Answer: [Correct Letter]
                Explanation: [Short explanation]`;

                const response = await callGemini(prompt);
                setQuizContent({ loading: false, text: response });
            };

            const handleSummarizeNote = async () => {
                if (!noteForm.content) return;
                const originalText = noteForm.content;
                setNoteForm(prev => ({ ...prev, content: "✨ Summarizing..." }));
                
                const prompt = `Summarize the following note into a concise paragraph, capturing the key points: \n\n"${originalText}"`;
                const summary = await callGemini(prompt);
                
                setNoteForm(prev => ({ ...prev, content: summary }));
            };

            // Calculated Stats
            const completedHabitsCount = habits.filter(h => h.completedToday).length;
            const progressPercentage = habits.length > 0 ? Math.round((completedHabitsCount / habits.length) * 100) : 0;
            
            const getYearProgress = () => {
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 0);
                const diff = now - start;
                const oneDay = 1000 * 60 * 60 * 24;
                const dayOfYear = Math.floor(diff / oneDay);
                const totalDays = 365 + (now.getFullYear() % 4 === 0 ? 1 : 0);
                return Math.floor((dayOfYear / totalDays) * 100);
            };
            const yearProgress = getYearProgress();
            const is2026 = new Date().getFullYear() === 2026;

            const navItems = [
                { id: 'dashboard', icon: Layout, label: 'Home' },
                { id: 'study', icon: BookOpen, label: 'Study' },
                { id: 'tasks', icon: CheckSquare, label: 'Tasks' },
                { id: 'focus', icon: Clock, label: 'Focus' },
                { id: 'games', icon: Gamepad2, label: 'Game Zone' },
                { id: 'attendance', icon: CalendarCheck, label: 'Class Schedule' },
                { id: 'screen-time', icon: Monitor, label: 'Screen Time' },
                { id: 'notes', icon: FileText, label: 'Notes' },
                { id: 'calendar', icon: Calendar, label: '2026' },
            ];

            // Define which items go in the main bar vs the more menu
            const mainNavIds = ['dashboard', 'study', 'tasks', 'focus', 'games'];
            const mobileNavItems = navItems.filter(item => mainNavIds.includes(item.id));
            const moreMenuNavItems = navItems.filter(item => !mainNavIds.includes(item.id));

            // Render Content
            const renderContent = () => {
                switch (activeTab) {
                    case 'study':
                        // Safe fallback for course data
                        const currentCourseData = courseData[studyCourse] || courseData['Web Development'];
                        const themeColor = currentCourseData.color; // 'orange', 'indigo', 'emerald'
                        
                        // Map color names to classes safely (simplified for this demo)
                        const getThemeClass = (type) => {
                            if (themeColor === 'orange') return type === 'bg' ? 'bg-orange-50 border-orange-100' : 'text-orange-700 bg-orange-100';
                            if (themeColor === 'emerald') return type === 'bg' ? 'bg-emerald-50 border-emerald-100' : 'text-emerald-700 bg-emerald-100';
                            return type === 'bg' ? 'bg-indigo-50 border-indigo-100' : 'text-indigo-700 bg-indigo-100';
                        };

                        return (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Course Selector Header */}
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <h2 className="text-xl md:text-2xl font-bold text-[var(--primary)] flex items-center gap-2">
                                        <BookOpen size={24} /> Study Center
                                    </h2>
                                    
                                    <div className="flex bg-white p-1 rounded-xl shadow-sm border border-slate-100 overflow-x-auto max-w-full">
                                        {Object.keys(courseData).map(course => (
                                            <button 
                                                key={course}
                                                onClick={() => setStudyCourse(course)}
                                                className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all flex items-center gap-2 ${
                                                    studyCourse === course 
                                                    ? 'bg-slate-800 text-white shadow-md' 
                                                    : 'text-slate-500 hover:bg-slate-50'
                                                }`}
                                            >
                                                {course === 'NDA' && <Target size={14}/>}
                                                {course === 'Chess Learning' && <Gamepad2 size={14}/>}
                                                {course === 'Web Development' && <Cpu size={14}/>}
                                                {course}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <Card className={getThemeClass('bg')}>
                                        <h3 className={`font-bold mb-4 flex items-center gap-2 ${themeColor === 'orange' ? 'text-orange-900' : themeColor === 'emerald' ? 'text-emerald-900' : 'text-indigo-900'}`}>
                                            <GraduationCap size={20}/> {studyCourse} Subjects
                                        </h3>
                                        <div className="space-y-3">
                                            {currentCourseData.subjects.map((subject, i) => (
                                                <div key={i} className="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border border-slate-50 hover:border-slate-200 transition-colors">
                                                    <span className="font-medium text-slate-700">{subject}</span>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleQuizMe(subject)} className={`text-xs px-2 py-1 rounded transition-colors flex items-center gap-1 ${getThemeClass('btn')}`}><Brain size={12}/> Quiz</button>
                                                        <button onClick={() => { setActiveTab('focus'); setFocusTask(`Study: ${subject}`); }} className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded hover:bg-slate-200 transition-colors">Focus</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                    <Card className="bg-white border-slate-100">
                                        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                            <Target size={20} className="text-red-500"/> Daily Goals
                                        </h3>
                                        <div className="space-y-3">
                                            {currentCourseData.goals.map((goal, i) => (
                                                <div key={i} className="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg transition-colors">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${getThemeClass('btn')}`}>{i + 1}</div>
                                                    <p className="text-sm text-slate-700 font-medium">{goal.text}</p>
                                                </div>
                                            ))}
                                            <button className="w-full py-2 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 text-sm font-bold hover:border-slate-300 hover:text-slate-500 transition-all mt-2">+ Add Personal Goal</button>
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        );
                    case 'attendance':
                        return <ClassSchedule schedule={schedule} setSchedule={setSchedule} />;
                    case 'games':
                        return (
                            <div className="space-y-8 animate-fadeIn h-full pb-20">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-xl md:text-2xl font-bold text-[var(--primary)] flex items-center gap-2">
                                        <Gamepad2 size={24} /> Game Zone
                                    </h2>
                                    <div className="flex gap-2">
                                        <span className="px-3 py-1 bg-slate-800 text-white rounded-full text-xs font-bold uppercase tracking-wider shadow-md">Hardcore Mode</span>
                                    </div>
                                </div>

                                {/* Games Container - Dark Theme Style */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <NeuralGridGame />
                                    <PatternEchoGame />
                                </div>

                                {/* Analysis Section */}
                                <section>
                                    <div className="flex items-center gap-2 mb-4">
                                        <div className="h-8 w-1 bg-indigo-500 rounded-full"></div>
                                        <h2 className="text-lg font-bold text-slate-800">Stats & Analysis</h2>
                                    </div>
                                    <MemoryAnalysis />
                                </section>
                            </div>
                        );
                    case 'tasks':
                        return (
                            <div className="space-y-8 animate-fadeIn pb-12">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-xl md:text-2xl font-bold text-[var(--primary)]">My Plan</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => setIsAIPlanModalOpen(true)} className="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-3 py-2 rounded-xl hover:shadow-lg transition-all text-sm font-medium">
                                            <Sparkles size={16} /> <span className="hidden md:inline">Smart Plan</span>
                                        </button>
                                        <button onClick={() => setIsHabitModalOpen(true)} className="flex items-center gap-2 bg-emerald-100 text-emerald-700 px-3 py-2 rounded-xl hover:bg-emerald-200 transition-colors text-sm font-medium">
                                            <Plus size={18} /> <span className="hidden md:inline">Habit</span>
                                        </button>
                                        <button onClick={() => setIsTaskModalOpen(true)} className="flex items-center gap-2 bg-[var(--primary)] text-white px-3 py-2 rounded-xl hover:bg-[var(--secondary)] transition-colors text-sm font-medium">
                                            <Plus size={18} /> <span className="hidden md:inline">Task</span>
                                        </button>
                                    </div>
                                </div>

                                {/* Habits Section */}
                                <section>
                                    <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><Leaf size={20} className="text-emerald-500"/> Daily Habits</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        {habits.map((habit) => (
                                            <div key={habit.id} onClick={() => toggleHabit(habit.id)} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 cursor-pointer hover:shadow-md transition-all">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${habit.color} bg-opacity-30`}>
                                                        <Activity size={16} />
                                                    </div>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${habit.completedToday ? 'bg-emerald-500 border-emerald-500' : 'border-slate-200'}`}>
                                                        {habit.completedToday && <CheckCircle size={14} className="text-white" />}
                                                    </div>
                                                </div>
                                                <h3 className={`font-bold text-sm text-slate-800 ${habit.completedToday ? 'line-through text-slate-400' : ''}`}>{habit.name}</h3>
                                                <div className="flex items-center gap-2 mt-1 text-[10px] text-slate-500">
                                                    <span>{habit.category}</span><span>•</span><span>{habit.streak} streak</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                {/* Habits Analysis */}
                                <section>
                                    <div className="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-2">
                                        <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                                            <BarChart2 size={20} className="text-indigo-500" /> Habit Analysis
                                        </h3>
                                        <div className="flex bg-slate-100 p-1 rounded-lg self-start md:self-auto">
                                            <button onClick={() => setAnalysisView('weekly')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${analysisView === 'weekly' ? 'bg-white text-emerald-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Weekly</button>
                                            <button onClick={() => setAnalysisView('monthly')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${analysisView === 'monthly' ? 'bg-white text-emerald-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Monthly</button>
                                        </div>
                                    </div>
                                    <Card>
                                        {analysisView === 'weekly' ? (
                                            <div>
                                                <h4 className="text-sm font-semibold text-slate-600 mb-6">Completion Rate (Last 7 Days)</h4>
                                                <SimpleBarChart data={[65, 80, 45, 90, 85, 95, 70]} labels={['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']} color="bg-emerald-400" />
                                            </div>
                                        ) : (
                                            <div>
                                                <h4 className="text-sm font-semibold text-slate-600 mb-6">Completion Rate (2025)</h4>
                                                <SimpleBarChart data={[70, 75, 80, 65, 85, 90, 88, 72, 80, 95, 85, 75]} labels={['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D']} color="bg-indigo-400" />
                                            </div>
                                        )}
                                    </Card>
                                </section>

                                {/* Tasks Section */}
                                <section>
                                    <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><CheckSquare size={20} className="text-indigo-500"/> Tasks List</h3>
                                    <Card>
                                        <div className="space-y-1">
                                            {tasks.length === 0 ? <div className="text-center py-10 text-slate-400">No tasks yet. Try Smart Plan!</div> : tasks.map((task) => (
                                                <div key={task.id} className="group flex items-center justify-between p-4 hover:bg-slate-50 rounded-xl transition-colors border-b border-slate-50 last:border-0">
                                                    <div className="flex items-center gap-4">
                                                        <button onClick={() => toggleTask(task.id)} className={`w-6 h-6 rounded border-2 flex items-center justify-center transition-colors ${task.completed ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300 hover:border-indigo-400'}`}>
                                                            {task.completed && <CheckSquare size={14} className="text-white" />}
                                                        </button>
                                                        <div>
                                                            <p className={`font-medium ${task.completed ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{task.title}</p>
                                                            <p className="text-xs text-slate-400 mt-0.5 flex items-center gap-2">
                                                                <span className={`px-1.5 py-0.5 rounded text-[10px] bg-slate-100 font-medium tracking-wide uppercase ${task.priority === 'High' ? 'text-red-600 bg-red-50' : 'text-slate-500'}`}>{task.priority}</span>
                                                                {task.tag === 'AI Plan' && <span className="text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-600 font-medium flex items-center gap-1"><Sparkles size={8}/> AI</span>}
                                                                <span className="text-[10px] text-slate-400 flex items-center gap-1"><Calendar size={10} /> {task.due}</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <button className="text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity" onClick={() => setTasks(tasks.filter(t => t.id !== task.id))}><X size={18} /></button>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                </section>
                            </div>
                        );
                    case 'calendar':
                        return (
                            <div className="h-full flex flex-col items-center justify-center text-center space-y-4 animate-fadeIn py-12">
                                <div className="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                                    <Calendar size={40} className="text-indigo-500" />
                                </div>
                                <h2 className="text-2xl font-bold text-[var(--primary)]">Calendar View 2026</h2>
                                <p className="text-slate-500 max-w-md">Your 2026 journey is being mapped out. Check back soon!</p>
                                <button onClick={() => setActiveTab('dashboard')} className="text-indigo-600 font-medium hover:underline mt-4">Return to Dashboard</button>
                            </div>
                        );
                    case 'settings':
                        return (
                            <div className="space-y-8 animate-fadeIn max-w-4xl mx-auto pb-12">
                                <h2 className="text-2xl font-bold text-[var(--primary)]">Settings</h2>
                                
                                {/* Theme Selection */}
                                <Card>
                                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><Layout size={20} className="text-indigo-500"/> Theme</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        {Object.entries(themes).map(([key, theme]) => (
                                            <button
                                                key={key}
                                                onClick={() => setCurrentTheme(key)}
                                                className={`p-4 rounded-xl border-2 flex flex-col items-center gap-3 transition-all ${currentTheme === key ? 'border-[var(--accent)] bg-slate-50' : 'border-slate-100 hover:border-slate-200'}`}
                                            >
                                                <div className="w-full h-12 rounded-lg shadow-sm flex overflow-hidden border border-slate-200">
                                                    <div className="w-1/3 h-full" style={{ backgroundColor: theme.colors.primary }}></div>
                                                    <div className="w-1/3 h-full" style={{ backgroundColor: theme.colors.secondary }}></div>
                                                    <div className="w-1/3 h-full" style={{ backgroundColor: theme.colors.bg }}></div>
                                                </div>
                                                <span className={`font-medium ${currentTheme === key ? 'text-[var(--primary)]' : 'text-slate-700'}`}>{theme.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                </Card>

                                {/* Appearance */}
                                <Card>
                                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><ImageIcon size={20} className="text-indigo-500"/> Appearance</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <button 
                                            onClick={() => setAppTheme('light')}
                                            className={`p-4 rounded-xl border-2 flex flex-col items-center gap-3 transition-all ${appTheme === 'light' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-100 hover:border-slate-200'}`}
                                        >
                                            <div className="w-full h-20 bg-[#f3f6f4] rounded-lg border border-slate-200 relative overflow-hidden shadow-inner">
                                                <div className="absolute top-3 left-3 w-16 h-6 bg-white rounded-md shadow-sm"></div>
                                                <div className="absolute top-12 left-3 w-10 h-2 bg-slate-200 rounded-full"></div>
                                            </div>
                                            <span className="font-medium text-slate-700">Light Mode</span>
                                        </button>
                                        <button 
                                            onClick={() => setAppTheme('dark')}
                                            className={`p-4 rounded-xl border-2 flex flex-col items-center gap-3 transition-all ${appTheme === 'dark' ? 'border-emerald-500 bg-slate-800' : 'border-slate-100 hover:border-slate-200'}`}
                                        >
                                            <div className="w-full h-20 bg-slate-900 rounded-lg border border-slate-700 relative overflow-hidden shadow-inner">
                                                <div className="absolute top-3 left-3 w-16 h-6 bg-slate-800 rounded-md shadow-sm border border-slate-700"></div>
                                                <div className="absolute top-12 left-3 w-10 h-2 bg-slate-700 rounded-full"></div>
                                            </div>
                                            <span className={`font-medium ${appTheme === 'dark' ? 'text-white' : 'text-slate-700'}`}>Dark Mode</span>
                                        </button>
                                    </div>
                                </Card>

                                {/* Security */}
                                <Card>
                                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><Lock size={20} className="text-emerald-500"/> Security & Privacy</h3>
                                    <div className="space-y-6">
                                        <div className="flex items-center justify-between p-2 hover:bg-slate-50 rounded-xl transition-colors">
                                            <div>
                                                <p className="font-medium text-slate-800">App Lock</p>
                                                <p className="text-sm text-slate-500">Require authentication to open ZenTrack</p>
                                            </div>
                                            <button 
                                                onClick={() => setSecuritySettings({...securitySettings, appLock: !securitySettings.appLock})}
                                                className={`w-12 h-6 rounded-full transition-colors relative ${securitySettings.appLock ? 'bg-emerald-500' : 'bg-slate-200'}`}
                                            >
                                                <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform duration-300 ${securitySettings.appLock ? 'translate-x-7' : 'translate-x-1'}`}></div>
                                            </button>
                                        </div>

                                        {securitySettings.appLock && (
                                            <div className="pl-4 border-l-2 border-slate-100 space-y-4 animate-fadeIn">
                                                <div className="flex items-center justify-between p-2 hover:bg-slate-50 rounded-xl transition-colors">
                                                    <div className="flex items-center gap-3">
                                                        <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><Fingerprint size={20}/></div>
                                                        <div>
                                                            <p className="font-medium text-slate-800">Biometric Unlock</p>
                                                            <p className="text-sm text-slate-500">Use fingerprint or Face ID</p>
                                                        </div>
                                                    </div>
                                                    <button 
                                                        onClick={() => setSecuritySettings({...securitySettings, biometric: !securitySettings.biometric})}
                                                        className={`w-12 h-6 rounded-full transition-colors relative ${securitySettings.biometric ? 'bg-indigo-500' : 'bg-slate-200'}`}
                                                    >
                                                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform duration-300 ${securitySettings.biometric ? 'translate-x-7' : 'translate-x-1'}`}></div>
                                                    </button>
                                                </div>
                                                
                                                <button className="flex items-center gap-3 w-full p-3 hover:bg-slate-50 rounded-xl transition-colors text-left group">
                                                    <div className="p-2 bg-slate-100 text-slate-600 rounded-lg group-hover:bg-white group-hover:shadow-sm transition-all"><Key size={20}/></div>
                                                    <div className="flex-1">
                                                        <p className="font-medium text-slate-800">Change PIN</p>
                                                        <p className="text-sm text-slate-500">Update your 4-digit access code</p>
                                                    </div>
                                                    <ChevronRight size={16} className="text-slate-400 group-hover:translate-x-1 transition-transform"/>
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </Card>
                            </div>
                        );
                    case 'focus':
                        return (
                            <div className="h-full flex flex-col animate-fadeIn space-y-6">
                                {/* Header for Focus Tab */}
                                <div className="flex items-center justify-between">
                                    <h2 className="text-2xl font-bold text-[#1b4332]">Focus Zone</h2>
                                    <div className="flex bg-slate-200 p-1 rounded-xl">
                                        <button 
                                            onClick={() => setFocusType('timer')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${focusType === 'timer' ? 'bg-white text-[#1b4332] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            Timer
                                        </button>
                                        <button 
                                            onClick={() => setFocusType('stopwatch')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${focusType === 'stopwatch' ? 'bg-white text-[#1b4332] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            Stopwatch
                                        </button>
                                    </div>
                                </div>

                                {/* Main Focus Card */}
                                <Card className="flex-1 flex flex-col items-center justify-center relative overflow-hidden bg-gradient-to-br from-[#1b4332] to-[#2d6a4f] text-white border-none shadow-xl min-h-[400px]">
                                    {/* Background Decoration */}
                                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden opacity-10 pointer-events-none">
                                        <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-white rounded-full blur-3xl transition-all duration-[4000ms] ${isTimerRunning || isStopwatchRunning ? 'scale-110 opacity-40' : 'scale-100 opacity-20'}`}></div>
                                    </div>

                                    <div className="z-10 flex flex-col items-center w-full max-w-md">
                                            {focusType === 'timer' ? (
                                                <>
                                                    <div className="relative mb-10">
                                                        {/* Improved Timer Visual */}
                                                        <div className="w-72 h-72 rounded-full border-8 border-emerald-900/20 flex items-center justify-center relative shadow-2xl bg-[#1b4332]/50 backdrop-blur-sm">
                                                            <svg className="absolute inset-0 w-full h-full transform -rotate-90 overflow-visible" viewBox="0 0 100 100">
                                                            <circle 
                                                                    cx="50" cy="50" r="46" 
                                                                    stroke="currentColor" strokeWidth="3" fill="none" 
                                                                    strokeDasharray={2 * Math.PI * 46}
                                                                    strokeDashoffset={2 * Math.PI * 46 * (1 - timerTime / timerDuration)}
                                                                    strokeLinecap="round"
                                                                    className="text-emerald-400 transition-all duration-1000 ease-linear drop-shadow-[0_0_10px_rgba(52,211,153,0.6)]"
                                                            />
                                                            </svg>
                                                            <div className="flex flex-col items-center z-10">
                                                                <div className="text-7xl font-mono font-bold tracking-tighter text-white drop-shadow-md">{formatTime(timerTime)}</div>
                                                                <div className={`text-xs mt-2 font-bold uppercase tracking-[0.2em] px-3 py-1 rounded-full transition-colors ${isTimerRunning ? 'bg-emerald-500 text-white' : 'bg-white/10 text-emerald-200'}`}>
                                                                    {isTimerRunning ? 'Focusing' : 'Paused'}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Controls */}
                                                    <div className="flex items-center gap-6 mb-8">
                                                        <button onClick={() => {setIsTimerRunning(false); setTimerTime(timerDuration);}} className="p-4 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all backdrop-blur-sm"><RotateCcw size={24} /></button>
                                                        <button onClick={() => setIsTimerRunning(!isTimerRunning)} className="p-6 rounded-full bg-white text-[var(--primary)] hover:scale-105 transition-all shadow-lg shadow-emerald-900/20">
                                                            {isTimerRunning ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" className="ml-1" />}
                                                        </button>
                                                    </div>

                                                    {/* Presets */}
                                                    <div className="flex gap-3">
                                                        {[15, 25, 45, 60].map(min => (
                                                            <button 
                                                                key={min} 
                                                                onClick={() => { setTimerDuration(min * 60); setTimerTime(min * 60); setIsTimerRunning(false); }}
                                                                className={`px-4 py-2 rounded-lg text-sm font-medium border transition-all ${timerDuration === min * 60 ? 'bg-emerald-400/20 border-emerald-400 text-emerald-100' : 'border-white/10 text-emerald-200 hover:bg-white/5'}`}
                                                            >
                                                                {min}m
                                                            </button>
                                                        ))}
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="relative mb-12 flex flex-col items-center">
                                                        <div className="text-7xl font-mono font-bold tracking-tighter mb-4">{formatTime(stopwatchTime)}</div>
                                                        <div className="text-emerald-200 text-sm font-medium uppercase tracking-widest">Session Duration</div>
                                                    </div>

                                                    <div className="flex items-center gap-6">
                                                        <button onClick={() => {setIsStopwatchRunning(false); setStopwatchTime(0);}} className="p-4 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all backdrop-blur-sm"><RotateCcw size={24} /></button>
                                                        <button onClick={() => setIsStopwatchRunning(!isStopwatchRunning)} className="p-6 rounded-full bg-white text-[var(--primary)] hover:scale-105 transition-all shadow-lg shadow-emerald-900/20">
                                                            {isStopwatchRunning ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" className="ml-1" />}
                                                        </button>
                                                        <button onClick={() => {
                                                            setIsStopwatchRunning(false);
                                                            setTotalFocusTime(prev => prev + stopwatchTime);
                                                            setStopwatchTime(0);
                                                        }} className="p-4 rounded-full bg-emerald-500 hover:bg-emerald-400 text-white transition-all shadow-lg" title="Finish & Save">
                                                            <CheckSquare size={24} />
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                    </div>
                                </Card>

                                {/* Total Focus Time Container */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <Card className="bg-indigo-50 border-indigo-100 flex items-center gap-4">
                                        <div className="p-3 bg-indigo-100 text-indigo-600 rounded-xl">
                                            <Activity size={24} />
                                        </div>
                                        <div>
                                            <p className="text-sm text-slate-500 font-medium">Total Focus Today</p>
                                            <h3 className="text-2xl font-bold text-slate-800">{Math.floor(totalFocusTime / 60)}m {totalFocusTime % 60}s</h3>
                                        </div>
                                    </Card>
                                    <Card className="bg-amber-50 border-amber-100 flex items-center gap-4">
                                        <div className="p-3 bg-amber-100 text-amber-600 rounded-xl">
                                            <Zap size={24} />
                                        </div>
                                        <div>
                                            <p className="text-sm text-slate-500 font-medium">Focus Sessions</p>
                                            <h3 className="text-2xl font-bold text-slate-800">
                                                {Math.ceil(totalFocusTime / (25 * 60))} <span className="text-sm font-normal text-slate-400">est. pomodoros</span>
                                            </h3>
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        );
                    case 'screen-time':
                        const savedMinutes = Math.max(0, Math.floor(screenTimeData.total * (1 - ((Math.max(0, simulatorHour - 8)) / 16)) * 0.8));
                        const savedTimeStr = `${Math.floor(savedMinutes / 60)}h ${savedMinutes % 60}m`;
                        
                        return (
                            <div className="space-y-6 animate-fadeIn">
                                <h2 className="text-xl md:text-2xl font-bold text-[var(--primary)] flex items-center gap-2">
                                    <Monitor size={24} /> Screen Time & Wellbeing
                                </h2>
                                
                                {/* Top Metrics */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <Card className="bg-slate-900 text-white border-none">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="text-slate-400 text-sm font-medium">Total Screen Time</p>
                                                <h3 className="text-3xl font-bold mt-1">6h 25m</h3>
                                            </div>
                                            <div className="p-2 bg-slate-800 rounded-lg"><Clock size={20} className="text-emerald-400"/></div>
                                        </div>
                                        <div className="mt-4 flex items-center gap-2 text-sm">
                                            <span className="text-emerald-400 font-medium">-12%</span>
                                            <span className="text-slate-500">vs last week</span>
                                        </div>
                                    </Card>
                                    
                                    <Card>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="text-slate-500 text-sm font-medium">Productive Ratio</p>
                                                <h3 className="text-3xl font-bold mt-1 text-slate-800">68%</h3>
                                            </div>
                                            <div className="p-2 bg-emerald-100 rounded-lg"><Zap size={20} className="text-emerald-600"/></div>
                                        </div>
                                        <div className="w-full bg-slate-100 h-2 mt-4 rounded-full overflow-hidden">
                                            <div className="h-full bg-emerald-500 w-[68%]"></div>
                                        </div>
                                        <p className="text-xs text-slate-400 mt-2">Target: 75%</p>
                                    </Card>

                                    <Card>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="text-slate-500 text-sm font-medium">Digital Hygiene</p>
                                                <h3 className="text-3xl font-bold mt-1 text-slate-800">85<span className="text-lg text-slate-400 font-normal">/100</span></h3>
                                            </div>
                                            <div className="p-2 bg-indigo-100 rounded-lg"><Activity size={20} className="text-indigo-600"/></div>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-4">Great job avoiding social media before 10 AM.</p>
                                    </Card>
                                </div>

                                {/* Middle Section */}
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    {/* Timeline & Apps */}
                                    <div className="lg:col-span-2 space-y-6">
                                        <Card>
                                            <h3 className="font-bold text-slate-800 mb-4">Session Timeline</h3>
                                            <div className="flex h-8 w-full rounded-lg overflow-hidden">
                                                <div className="bg-emerald-400 w-[30%]" title="Deep Work"></div>
                                                <div className="bg-slate-200 w-[5%]" title="Break"></div>
                                                <div className="bg-emerald-400 w-[25%]" title="Deep Work"></div>
                                                <div className="bg-amber-400 w-[15%]" title="Meeting"></div>
                                                <div className="bg-red-400 w-[10%]" title="Social Media"></div>
                                                <div className="bg-emerald-300 w-[15%]" title="Admin"></div>
                                            </div>
                                            <div className="flex justify-between text-xs text-slate-400 mt-2">
                                                <span>8:00 AM</span>
                                                <span>12:00 PM</span>
                                                <span>4:00 PM</span>
                                                <span>8:00 PM</span>
                                            </div>
                                            <div className="flex gap-4 mt-4 justify-center">
                                                <div className="flex items-center gap-2 text-xs font-medium text-slate-600"><div className="w-3 h-3 bg-emerald-400 rounded-full"></div> Productive</div>
                                                <div className="flex items-center gap-2 text-xs font-medium text-slate-600"><div className="w-3 h-3 bg-amber-400 rounded-full"></div> Communication</div>
                                                <div className="flex items-center gap-2 text-xs font-medium text-slate-600"><div className="w-3 h-3 bg-red-400 rounded-full"></div> Distraction</div>
                                            </div>
                                        </Card>

                                        <Card>
                                            <h3 className="font-bold text-slate-800 mb-4">App Usage Breakdown</h3>
                                            <div className="space-y-4">
                                                {screenTimeData.apps.map((app, i) => (
                                                    <div key={i} className="flex items-center gap-3">
                                                        <div className="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-lg text-lg">{app.icon}</div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between mb-1">
                                                                <span className="text-sm font-medium text-slate-700">{app.name}</span>
                                                                <span className="text-xs text-slate-500">{Math.floor(app.time / 60)}h {app.time % 60}m</span>
                                                            </div>
                                                            <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                                                <div 
                                                                    className={`h-full rounded-full ${app.type === 'productive' ? 'bg-emerald-500' : app.type === 'distraction' ? 'bg-red-400' : 'bg-amber-400'}`} 
                                                                    style={{ width: `${(app.time / 180) * 100}%` }}
                                                                ></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </Card>
                                    </div>

                                    {/* Focus Overlay & Context Switching */}
                                    <div className="space-y-6">
                                        <Card>
                                            <h3 className="font-bold text-slate-800 mb-4">Content Breakdown</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="font-medium text-slate-600">Social Media</span>
                                                        <span className="text-slate-400">45m</span>
                                                    </div>
                                                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                                        <div className="h-full bg-pink-400 w-[35%]"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="font-medium text-slate-600">Video Streaming</span>
                                                        <span className="text-slate-400">60m</span>
                                                    </div>
                                                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                                        <div className="h-full bg-red-500 w-[48%]"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="font-medium text-slate-600">Other</span>
                                                        <span className="text-slate-400">20m</span>
                                                    </div>
                                                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                                        <div className="h-full bg-amber-400 w-[17%]"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </Card>

                                        <Card className="bg-gradient-to-br from-indigo-50 to-white">
                                            <h3 className="font-bold text-slate-800 mb-2">Context Switching</h3>
                                            <div className="flex items-end gap-2 mb-2">
                                                <span className="text-4xl font-bold text-indigo-900">{screenTimeData.switches}</span>
                                                <span className="text-sm text-indigo-700 mb-1">switches today</span>
                                            </div>
                                            <p className="text-xs text-slate-500 mb-4">High fragmentation detected between 2 PM - 4 PM.</p>
                                            <div className="h-24 flex items-end gap-1">
                                                {[4, 8, 3, 12, 15, 8, 5, 2].map((h, i) => (
                                                    <div key={i} className="flex-1 bg-indigo-200 rounded-t-sm hover:bg-indigo-400 transition-colors" style={{ height: `${h * 5}%` }}></div>
                                                ))}
                                            </div>
                                        </Card>

                                        <Card>
                                            <h3 className="font-bold text-slate-800 mb-4">Fatigue Curve</h3>
                                            <div className="relative h-32 w-full">
                                                <svg className="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 100 100">
                                                    {/* Mock Curve */}
                                                    <path d="M0,90 Q20,80 40,60 T80,30 T100,10" fill="none" stroke="#f43f5e" strokeWidth="3" strokeLinecap="round" />
                                                    <path d="M0,90 L100,90" stroke="#e2e8f0" strokeWidth="1" strokeDasharray="4 4" />
                                                </svg>
                                                <div className="absolute bottom-0 left-0 text-[10px] text-slate-400">8 AM</div>
                                                <div className="absolute bottom-0 right-0 text-[10px] text-slate-400">8 PM</div>
                                                <div className="absolute top-0 right-0 text-[10px] text-rose-500 font-bold">High Fatigue</div>
                                            </div>
                                            <p className="text-xs text-slate-500 mt-2">Cognitive load peaks at 4 PM. Consider a break.</p>
                                        </Card>
                                    </div>
                                </div>

                                {/* Bottom: Simulator */}
                                <Card className="bg-slate-800 text-white overflow-hidden relative">
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl -mr-16 -mt-16"></div>
                                    <div className="relative z-10">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                                            <div>
                                                <h3 className="text-lg font-bold flex items-center gap-2"><Coffee size={20} className="text-amber-400"/> "If I stopped at..." Simulator</h3>
                                                <p className="text-slate-400 text-sm">See how stopping earlier affects your wellbeing.</p>
                                            </div>
                                            <div className="mt-4 md:mt-0 text-right">
                                                <div className="text-3xl font-bold text-emerald-400">{savedTimeStr}</div>
                                                <div className="text-xs text-slate-400">Potential time reclaimed</div>
                                            </div>
                                        </div>

                                        <div className="space-y-6">
                                            <div>
                                                <div className="flex justify-between text-sm font-medium mb-2">
                                                    <span className="text-slate-300">Stop work at: <span className="text-white text-lg">{simulatorHour}:00</span></span>
                                                </div>
                                                <input 
                                                    type="range" 
                                                    min="12" 
                                                    max="24" 
                                                    step="1" 
                                                    value={simulatorHour} 
                                                    onChange={(e) => setSimulatorHour(parseInt(e.target.value))}
                                                    className="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                                                />
                                                <div className="flex justify-between text-xs text-slate-500 mt-2">
                                                    <span>12:00 PM</span>
                                                    <span>6:00 PM</span>
                                                    <span>12:00 AM</span>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-slate-700">
                                                <div>
                                                    <p className="text-xs text-slate-400">Fatigue Reduction</p>
                                                    <p className="text-lg font-bold text-emerald-300">-{Math.round((24 - simulatorHour) * 3.5)}%</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-slate-400">Sleep Quality</p>
                                                    <p className="text-lg font-bold text-indigo-300">+{Math.round((24 - simulatorHour) * 4.2)}%</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-slate-400">Books Read (Year)</p>
                                                    <p className="text-lg font-bold text-amber-300">+{Math.round((24 - simulatorHour) * 1.5)}</p>
                                                </div>
                                                 <div>
                                                    <p className="text-xs text-slate-400">Family Time</p>
                                                    <p className="text-lg font-bold text-pink-300">+{Math.floor((24 - simulatorHour) * 0.8)}h</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        );
                    case 'notes':
                        return (
                            <div className="space-y-6 animate-fadeIn h-full flex flex-col">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-xl md:text-2xl font-bold text-[var(--primary)]">My Notes</h2>
                                    {notesView === 'list' && (
                                        <button onClick={() => openNoteEditor()} className="flex items-center gap-2 bg-[var(--primary)] text-white px-3 py-2 rounded-xl hover:bg-[var(--secondary)] transition-colors text-sm font-medium">
                                            <Plus size={18} /> New Note
                                        </button>
                                    )}
                                </div>
                                {notesView === 'list' ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {notes.map(note => (
                                            <div key={note.id} onClick={() => openNoteEditor(note)} className="group bg-white p-6 rounded-2xl shadow-sm border border-slate-100 cursor-pointer hover:shadow-md transition-all hover:border-indigo-100 flex flex-col h-48">
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${note.category === 'Journal' ? 'bg-purple-100 text-purple-700' : note.category === 'Ideas' ? 'bg-amber-100 text-amber-700' : note.category === 'Work' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-700'}`}>{note.category}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); handleDeleteNote(note.id); }} className="text-slate-300 hover:text-red-400 p-1 rounded-full hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"><Trash2 size={16} /></button>
                                                </div>
                                                <h3 className="font-bold text-lg text-slate-800 mb-2 truncate">{note.title}</h3>
                                                <p className="text-sm text-slate-500 flex-1 overflow-hidden line-clamp-3 leading-relaxed">{note.content}</p>
                                                <div className="pt-4 mt-2 border-t border-slate-50 text-xs text-slate-400 flex items-center justify-between">
                                                    <span>{note.date}</span>
                                                    <span className="group-hover:translate-x-1 transition-transform text-indigo-400"><Edit3 size={14} /></span>
                                                </div>
                                            </div>
                                        ))}
                                        {notes.length === 0 && (
                                            <div className="col-span-full py-12 flex flex-col items-center justify-center text-slate-400 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                                                <FileText size={48} className="mb-4 opacity-50" />
                                                <p>No notes yet. Start writing your thoughts!</p>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <Card className="flex-1 flex flex-col h-full overflow-hidden">
                                        <div className="flex flex-col md:flex-row md:items-center gap-4 mb-6 pb-4 border-b border-slate-100">
                                            <div className="flex items-center gap-4 w-full">
                                                <button onClick={() => setNotesView('list')} className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-500"><ArrowLeft size={20} /></button>
                                                <input type="text" placeholder="Note Title..." value={noteForm.title} onChange={(e) => setNoteForm({...noteForm, title: e.target.value})} className="flex-1 text-lg md:text-xl font-bold bg-transparent border-none focus:ring-0 placeholder:text-slate-300 text-[var(--primary)]" />
                                            </div>
                                            <div className="flex gap-2 w-full md:w-auto justify-end">
                                                <button onClick={handleSummarizeNote} className="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors flex items-center gap-2 text-sm font-medium" title="AI Summarize"><Sparkles size={16} /> <span className="hidden md:inline">Summarize</span></button>
                                                <button onClick={handleAddImage} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors" title="Add Image"><ImageIcon size={20} /></button>
                                                <select value={noteForm.category} onChange={(e) => setNoteForm({...noteForm, category: e.target.value})} className="text-sm border-none bg-slate-50 rounded-lg px-3 py-2 text-slate-600 focus:ring-2 focus:ring-indigo-200">
                                                    <option>Journal</option><option>Ideas</option><option>Work</option><option>Personal</option>
                                                </select>
                                                <button onClick={handleSaveNote} className="flex items-center gap-2 bg-[var(--primary)] text-white px-4 py-2 rounded-lg hover:bg-[var(--secondary)] transition-all shadow-lg shadow-emerald-900/10 text-sm font-medium"><Save size={18} /> Save</button>
                                            </div>
                                        </div>
                                        <textarea placeholder="Start typing your thoughts here..." value={noteForm.content} onChange={(e) => setNoteForm({...noteForm, content: e.target.value})} className="flex-1 w-full resize-none border-none focus:ring-0 text-slate-700 leading-relaxed text-base md:text-lg bg-transparent p-0 custom-scrollbar"></textarea>
                                    </Card>
                                )}
                            </div>
                        );
                    default:
                        // Dashboard
                        const nextClass = getNextClass();
                        const latestNote = notes.length > 0 ? notes[notes.length - 1] : null;

                        return (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full animate-fadeIn pb-12">
                                <div className="lg:col-span-2 space-y-6">
                                    {/* Top Row Stats */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <Card className="flex flex-col md:flex-row items-center justify-between relative overflow-hidden bg-gradient-to-br from-[#e0c3fc] to-[#8ec5fc] text-white border-none shadow-lg">
                                            <div className="z-10 text-white text-center md:text-left mb-4 md:mb-0">
                                                <h3 className="text-lg font-semibold mb-1 text-indigo-900">Daily Focus</h3>
                                                <p className="text-indigo-800/80 text-sm mb-4">You're doing great!</p>
                                                <div className="flex items-baseline gap-2 justify-center md:justify-start">
                                                    <span className="text-4xl font-bold text-indigo-900">{completedHabitsCount}</span>
                                                    <span className="text-indigo-800">/ {habits.length} Habits</span>
                                                </div>
                                            </div>
                                            <div className="z-10 bg-white/20 p-2 rounded-full backdrop-blur-sm">
                                                <ProgressCircle percentage={progressPercentage} color="var(--primary)" size={80} strokeWidth={8} />
                                            </div>
                                            <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                                            <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-indigo-500/10 rounded-full blur-2xl"></div>
                                        </Card>

                                        {/* New Quick Glance Grid */}
                                        <div className="grid grid-cols-2 gap-4">
                                            <Card className="bg-slate-50 border-slate-100 flex flex-col justify-between hover:border-indigo-200 transition-colors cursor-pointer" onClick={() => setActiveTab('notes')}>
                                                <div className="flex justify-between items-start">
                                                    <div className="p-2 bg-white rounded-lg shadow-sm text-amber-500"><FileText size={18} /></div>
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setActiveTab('notes');
                                                            openNoteEditor();
                                                        }}
                                                        className="p-1.5 bg-white text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors border border-slate-100 shadow-sm"
                                                        title="Add New Note"
                                                    >
                                                        <Plus size={16} />
                                                    </button>
                                                </div>
                                                <div className="mt-3">
                                                    <span className="text-[10px] text-slate-400 mb-1 block">Latest Note</span>
                                                    <p className="font-bold text-slate-800 text-sm truncate">{latestNote ? latestNote.title : "No notes"}</p>
                                                    <p className="text-xs text-slate-500 truncate">{latestNote ? latestNote.category : "Create one now"}</p>
                                                </div>
                                            </Card>

                                            <Card className="bg-slate-50 border-slate-100 flex flex-col justify-between hover:border-emerald-200 transition-colors cursor-pointer" onClick={() => setActiveTab('screen-time')}>
                                                <div className="flex justify-between items-start">
                                                    <div className="p-2 bg-white rounded-lg shadow-sm text-emerald-500"><Monitor size={18} /></div>
                                                    <span className="text-[10px] text-slate-400">Screen Time</span>
                                                </div>
                                                <div className="mt-3">
                                                    <p className="font-bold text-slate-800 text-sm">{Math.floor(screenTimeData.total / 60)}h {screenTimeData.total % 60}m</p>
                                                    <p className="text-xs text-emerald-600 font-medium">85% Productive</p>
                                                </div>
                                            </Card>
                                        </div>
                                    </div>

                                    {/* Habits Section */}
                                    <div className="space-y-4">
                                        <div className="flex items-center justify-between">
                                            <h2 className="text-xl md:text-2xl font-bold text-[var(--primary)] flex items-center gap-2">
                                                <Leaf size={24} className="text-[#52b788]" /> My Habits
                                            </h2>
                                            <button onClick={() => setIsHabitModalOpen(true)} className="flex items-center gap-2 text-sm font-medium text-[var(--primary)] hover:bg-emerald-50 px-3 py-2 rounded-lg transition-colors">
                                                <Plus size={16} /> New
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {habits.map((habit) => (
                                                <div key={habit.id} onClick={() => toggleHabit(habit.id)} className={`group relative p-5 rounded-2xl cursor-pointer transition-all duration-300 border-2 ${habit.completedToday ? 'bg-white border-emerald-100 shadow-sm' : 'bg-white border-transparent shadow-sm hover:shadow-md hover:-translate-y-1'}`}>
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center ${habit.color} bg-opacity-30`}>
                                                                {habit.category === 'Mind' && <span className="text-xl">🧘‍♀️</span>}
                                                                {habit.category === 'Body' && <span className="text-xl">🏃‍♀️</span>}
                                                                {habit.category === 'Growth' && <span className="text-xl">📚</span>}
                                                                {habit.category === 'Health' && <span className="text-xl">💧</span>}
                                                            </div>
                                                            <div>
                                                                <h4 className={`font-bold text-base md:text-lg ${habit.completedToday ? 'text-slate-500 line-through' : 'text-slate-800'}`}>{habit.name}</h4>
                                                                <span className="text-xs font-medium text-slate-400 bg-slate-50 px-2 py-0.5 rounded-md mt-1 inline-block">{habit.streak} day streak 🔥</span>
                                                            </div>
                                                        </div>
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 ${habit.completedToday ? 'bg-emerald-500 text-white scale-110' : 'bg-slate-100 text-slate-300 group-hover:bg-emerald-100 group-hover:text-emerald-500'}`}>
                                                            <CheckCircle size={18} fill={habit.completedToday ? "currentColor" : "none"} />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Motivation */}
                                    <div className="mt-8 bg-gradient-to-r from-indigo-50 to-emerald-50 rounded-2xl p-6 border border-indigo-100 flex flex-col md:flex-row gap-4 items-start relative overflow-hidden">
                                        <div className="bg-white p-3 rounded-full shadow-sm z-10 shrink-0"><Quote className="text-indigo-400" size={24} /></div>
                                        <div className="z-10">
                                            <p className="text-lg font-medium text-slate-800 italic">"Discipline is doing what needs to be done, even if you don't want to do it."</p>
                                            <p className="text-sm text-slate-500 mt-2 font-medium">— Daily Wisdom</p>
                                        </div>
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-200/20 rounded-full -mr-10 -mt-10 blur-xl"></div>
                                    </div>
                                </div>

                                {/* Sidebar */}
                                <div className="lg:col-span-1 space-y-6">
                                    {/* Up Next Card - Light Theme */}
                                    <div className="bg-emerald-50/50 rounded-2xl shadow-sm border border-emerald-100 p-6 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-200/20 rounded-full blur-2xl -mr-10 -mt-10"></div>
                                        <div className="relative z-10">
                                            <div className="flex justify-between items-center mb-4">
                                                <h2 className="text-lg font-bold flex items-center gap-2 text-emerald-900">
                                                    <Clock size={20} className="text-emerald-600" /> Up Next
                                                </h2>
                                                <button onClick={() => { setActiveTab('attendance'); setIsMoreMenuOpen(true); }} className="text-xs text-emerald-600 hover:text-emerald-700 font-medium transition-colors">View All</button>
                                            </div>
                                            {nextClass ? (
                                                <div className="bg-white rounded-xl p-4 border border-emerald-100 shadow-sm">
                                                    <h3 className="font-bold text-lg text-slate-800 mb-1">{nextClass.name}</h3>
                                                    <div className="flex items-center gap-2 text-sm text-slate-500 mb-2">
                                                        <MapPin size={14} className="text-emerald-500" /> {nextClass.location}
                                                    </div>
                                                    <div className="inline-block bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded">
                                                        {nextClass.start} - {nextClass.end}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="bg-white/50 rounded-xl p-6 text-center border border-emerald-100 border-dashed">
                                                    <p className="text-slate-500 text-sm">No classes remaining today.</p>
                                                    <p className="text-slate-400 text-xs mt-1">Time to study or relax!</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Sidebar Tasks */}
                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col h-full max-h-[500px]">
                                        <div className="flex items-center justify-between mb-6">
                                            <h2 className="text-lg font-bold text-[var(--primary)]">Today's Tasks</h2>
                                            <button className="text-slate-400 hover:text-[var(--primary)] transition-colors"><MoreHorizontal size={20} /></button>
                                        </div>
                                        <div className="flex-1 space-y-3 overflow-y-auto pr-2 custom-scrollbar">
                                            {tasks.map((task) => (
                                                <div key={task.id} className={`p-4 rounded-xl border transition-all duration-200 ${task.completed ? 'bg-slate-50 border-transparent opacity-60' : 'bg-white border-slate-100 hover:border-indigo-200 hover:shadow-sm'}`}>
                                                    <div className="flex items-start gap-3">
                                                        <button onClick={() => toggleTask(task.id)} className={`mt-1 min-w-[20px] h-5 rounded border flex items-center justify-center transition-colors ${task.completed ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300 hover:border-indigo-400'}`}>
                                                            {task.completed && <CheckSquare size={14} className="text-white" />}
                                                        </button>
                                                        <div className="flex-1">
                                                            <p className={`text-sm font-medium ${task.completed ? 'text-slate-500 line-through' : 'text-slate-800'}`}>{task.title}</p>
                                                            <div className="flex items-center gap-2 mt-2">
                                                                <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${task.priority === 'High' ? 'bg-pink-100 text-pink-700' : task.priority === 'Medium' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-600'}`}>{task.priority}</span>
                                                                <span className="text-[10px] text-slate-400 flex items-center gap-1"><Calendar size={10} /> {task.due}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            <button onClick={() => setIsTaskModalOpen(true)} className="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-medium text-sm hover:border-indigo-300 hover:text-indigo-500 transition-colors flex items-center justify-center gap-2">
                                                <Plus size={16} /> Add New Task
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* 2026 Progress */}
                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                                        <div className="flex justify-between items-end mb-2">
                                            <h3 className="font-bold text-[var(--primary)] text-sm">{is2026 ? "2026 Progress" : "Countdown to 2026"}</h3>
                                            <span className="text-sm font-medium text-emerald-600">{yearProgress}%</span>
                                        </div>
                                        <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                                            <div className="h-full bg-gradient-to-r from-emerald-400 to-indigo-500 transition-all duration-1000 ease-out relative" style={{ width: `${yearProgress}%` }}>
                                                <div className="absolute top-0 left-0 w-full h-full bg-white/20 animate-pulse"></div>
                                            </div>
                                        </div>
                                        <p className="text-[10px] text-slate-400 mt-2 text-right">Make every day count.</p>
                                    </div>
                                </div>
                            </div>
                        );
                }
            };

            return (
                <div className="flex h-screen bg-[var(--bg-main)] font-sans text-slate-800 overflow-hidden">
                    
                    {/* Sidebar - Desktop */}
                    <aside className="hidden lg:flex w-64 bg-[var(--primary)] text-white flex-col justify-between transition-all duration-300 shadow-xl z-20 relative">
                        <div className="flex-1">
                            <div className="h-20 flex items-center justify-start px-8 border-b border-[var(--secondary)] cursor-pointer" onClick={() => setActiveTab('dashboard')}>
                                <div className="bg-emerald-400 p-2 rounded-lg">
                                    <Leaf size={24} className="text-[var(--primary)]" />
                                </div>
                                <span className="ml-3 font-bold text-xl tracking-tight text-emerald-50">ZenTrack</span>
                            </div>

                            <nav className="mt-8 flex flex-col gap-2 px-3">
                                {navItems.map((item) => (
                                    <button
                                        key={item.id}
                                        onClick={() => setActiveTab(item.id)}
                                        className={`flex items-center p-3 rounded-xl transition-all duration-200 group ${
                                            activeTab === item.id 
                                                ? 'bg-[var(--accent)] text-white shadow-lg shadow-emerald-900/20' 
                                                : 'text-emerald-100 hover:bg-[var(--secondary)] hover:text-white'
                                        }`}
                                    >
                                        <item.icon size={20} className={activeTab === item.id ? 'text-white' : 'text-emerald-200 group-hover:text-white'} />
                                        <span className="ml-3 font-medium">{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                        </div>

                        {/* Sidebar Bottom Section (Settings & Profile) */}
                        <div className="p-4 border-t border-[var(--secondary)] bg-[var(--sidebar-bottom)]">
                            {/* Profile Section (Desktop) */}
                            <div className="relative" ref={desktopProfileRef}>
                                <div 
                                    onClick={() => setIsDesktopProfileOpen(!isDesktopProfileOpen)}
                                    className="flex items-center gap-3 p-3 rounded-xl hover:bg-[var(--secondary)] cursor-pointer transition-colors"
                                >
                                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-300 to-purple-300 border-2 border-[var(--accent)] flex items-center justify-center shrink-0 overflow-hidden">
                                        {profileImage ? <img src={profileImage} alt="Profile" className="w-full h-full object-cover" /> : <User size={18} className="text-[var(--primary)]" />}
                                    </div>
                                    <div className="flex-1 overflow-hidden">
                                        <p className="text-sm font-bold text-white truncate">{profileData.name}</p>
                                    </div>
                                    <MoreVertical size={16} className="text-emerald-400" />
                                </div>

                                {isDesktopProfileOpen && (
                                    <div className="absolute bottom-full left-0 w-60 bg-white rounded-xl shadow-2xl border border-slate-100 mb-2 p-2 animate-in fade-in slide-in-from-bottom-2 z-50">
                                        <div className="px-4 py-3 border-b border-slate-50 mb-1">
                                            <p className="text-sm font-bold text-slate-800">{profileData.name}</p>
                                            <p className="text-xs text-slate-400">{profileData.email}</p>
                                        </div>
                                        <button onClick={() => { setIsDesktopProfileOpen(false); setIsEditProfileModalOpen(true); }} className="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2 rounded-lg"><User size={16} /> Edit Profile</button>
                                        <button onClick={() => { setIsDesktopProfileOpen(false); setActiveTab('settings'); }} className="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2 rounded-lg"><Settings size={16} /> Settings</button>
                                        <button className="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50 flex items-center gap-2 rounded-lg"><LogOut size={16} /> Sign Out</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>

                    {/* Mobile Bottom Navigation - Auto Hide */}
                    <nav 
                        className={`lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-[60] flex justify-around items-center p-2 safe-area-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)] transition-transform duration-300 ease-in-out ${
                            isNavVisible ? 'translate-y-0' : 'translate-y-full'
                        }`}
                    >
                        {mobileNavItems.map((item) => (
                            <button
                                key={item.id}
                                onClick={() => { setActiveTab(item.id); setIsMoreMenuOpen(false); }}
                                className={`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${
                                    activeTab === item.id && !isMoreMenuOpen
                                        ? 'text-[var(--primary)]' 
                                        : 'text-slate-400 hover:text-slate-600'
                                }`}
                            >
                                <item.icon size={20} strokeWidth={activeTab === item.id && !isMoreMenuOpen ? 2.5 : 2} />
                                <span className="text-[10px] font-medium mt-1">{item.label}</span>
                            </button>
                        ))}
                        <button
                            ref={moreBtnRef}
                            onClick={() => setIsMoreMenuOpen(!isMoreMenuOpen)}
                            className={`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${
                                isMoreMenuOpen ? 'text-[var(--primary)]' : 'text-slate-400 hover:text-slate-600'
                            }`}
                        >
                            <div className={`transition-transform duration-300 ${isMoreMenuOpen ? 'rotate-90' : 'rotate-0'}`}>
                                {isMoreMenuOpen ? <X size={20} strokeWidth={2.5} /> : <MoreHorizontal size={20} strokeWidth={2} />}
                            </div>
                            <span className="text-[10px] font-medium mt-1">{isMoreMenuOpen ? 'Close' : 'More'}</span>
                        </button>
                    </nav>

                    {/* Mobile More Menu - Full Page Overlay */}
                    {isMoreMenuOpen && (
                        <div className="lg:hidden fixed inset-0 z-[50] bg-[#f3f6f4] animate-fadeIn flex flex-col pt-safe-top">
                            <div className="p-6 pt-20 pb-32 overflow-y-auto h-full">
                                <h2 className="text-2xl font-bold text-[var(--primary)] mb-2">More Tools</h2>
                                <p className="text-slate-500 mb-6">Everything else you need.</p>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    {moreMenuNavItems.map(item => (
                                        <button 
                                            key={item.id}
                                            onClick={() => { setActiveTab(item.id); setIsMoreMenuOpen(false); }}
                                            className={`p-6 rounded-2xl flex flex-col items-start justify-between gap-4 transition-all shadow-sm border ${activeTab === item.id ? 'bg-[var(--primary)] text-white border-[var(--primary)]' : 'bg-white text-slate-600 border-slate-100 hover:border-emerald-200'}`}
                                        >
                                            <div className={`p-3 rounded-xl ${activeTab === item.id ? 'bg-white/20' : 'bg-slate-50'}`}>
                                                <item.icon size={24} />
                                            </div>
                                            <span className="font-bold text-lg">{item.label}</span>
                                        </button>
                                    ))}
                                </div>

                                {/* Quick Actions in Menu */}
                                <div className="mt-8">
                                    <h3 className="font-bold text-slate-700 mb-4">Quick Settings</h3>
                                    <div className="bg-white rounded-xl border border-slate-100 divide-y divide-slate-50">
                                        <button onClick={() => { setAppTheme(appTheme === 'dark' ? 'light' : 'dark'); }} className="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                                            <span className="flex items-center gap-3 text-slate-600"><ImageIcon size={18} /> Theme</span>
                                            <span className="text-xs font-medium text-slate-400 bg-slate-100 px-2 py-1 rounded capitalize">{appTheme}</span>
                                        </button>
                                        <button onClick={() => { setActiveTab('settings'); setIsMoreMenuOpen(false); }} className="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                                            <span className="flex items-center gap-3 text-slate-600"><Settings size={18} /> Settings</span>
                                            <ChevronRight size={16} className="text-slate-300" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col overflow-hidden relative">
                        {/* Top Header - High Z-Index for Dropdown Visibility */}
                        {activeTab === 'dashboard' && (
                            <header className="h-24 md:h-28 bg-white border-b border-slate-100 flex items-center justify-between px-4 lg:px-8 z-[50] shrink-0 relative">
                                <div>
                                    <div className="flex items-center gap-2 text-emerald-600 font-semibold mb-1 text-sm md:text-base tracking-wide uppercase">
                                        <Calendar size={16} />
                                        <span>{currentDate.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
                                    </div>
                                    <h1 className="text-2xl md:text-3xl font-bold text-[var(--primary)]">Hello, {profileData.name.split(' ')[0]}</h1>
                                </div>
                                <div className="flex items-center gap-3 md:gap-6">
                                    <div className="relative hidden md:block">
                                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                        <input 
                                            type="text" 
                                            placeholder="Search tasks & habits..." 
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            className="pl-10 pr-4 py-2 rounded-full bg-slate-50 border-none focus:ring-2 focus:ring-[#95d5b2] outline-none text-sm w-64 transition-all" 
                                        />
                                        {searchQuery && (
                                            <div className="absolute left-0 top-full mt-2 w-80 bg-white rounded-xl shadow-xl border border-slate-100 py-2 animate-in fade-in slide-in-from-top-2 z-[60]">
                                                {searchResults.length > 0 ? (
                                                    searchResults.map(item => (
                                                        <div key={item.id + item.type} onClick={() => {
                                                            if(item.type === 'task') { setActiveTab('tasks'); }
                                                            else { setActiveTab('habits'); }
                                                            setSearchQuery('');
                                                        }} className="px-4 py-3 hover:bg-slate-50 transition-colors cursor-pointer border-b border-slate-50 last:border-0 flex items-center gap-3">
                                                            {item.type === 'task' ? <CheckSquare size={16} className="text-indigo-500"/> : <Activity size={16} className="text-emerald-500"/>}
                                                            <div>
                                                                <p className="text-sm font-medium text-slate-800">{item.type === 'task' ? item.title : item.name}</p>
                                                                <p className="text-xs text-slate-500 capitalize">{item.type}</p>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="px-4 py-3 text-sm text-slate-500 text-center">No results found.</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    <div className="relative" ref={notificationRef}>
                                        <button onClick={() => setIsNotificationsOpen(!isNotificationsOpen)} className="relative p-2 rounded-full hover:bg-slate-50 transition-colors">
                                            <Bell size={20} className="text-slate-600" />
                                            <span className="absolute top-1 right-1 w-2 h-2 bg-pink-400 rounded-full border border-white"></span>
                                        </button>
                                        {isNotificationsOpen && (
                                            <div className="absolute right-0 top-12 w-80 bg-white rounded-xl shadow-xl border border-slate-100 py-2 animate-in fade-in slide-in-from-top-2 z-[60]">
                                                <div className="px-4 py-2 border-b border-slate-50 flex justify-between items-center">
                                                    <h3 className="font-bold text-slate-800">Notifications</h3>
                                                    <button className="text-xs text-indigo-500 hover:underline">Mark all read</button>
                                                </div>
                                                <div className="max-h-64 overflow-y-auto custom-scrollbar">
                                                    <div className="px-4 py-3 hover:bg-slate-50 transition-colors cursor-pointer border-b border-slate-50 last:border-0">
                                                        <p className="text-sm font-medium text-slate-800">Drink Water Reminder</p>
                                                        <p className="text-xs text-slate-500 mt-1">It's been 2 hours since your last glass.</p>
                                                        <p className="text-[10px] text-slate-400 mt-1">10 min ago</p>
                                                    </div>
                                                    <div className="px-4 py-3 hover:bg-slate-50 transition-colors cursor-pointer border-b border-slate-50 last:border-0">
                                                        <p className="text-sm font-medium text-slate-800">Task Due Soon</p>
                                                        <p className="text-xs text-slate-500 mt-1">"2026 Vision Board" is due at 2:00 PM.</p>
                                                        <p className="text-[10px] text-slate-400 mt-1">1 hour ago</p>
                                                    </div>
                                                    <div className="px-4 py-3 hover:bg-slate-50 transition-colors cursor-pointer">
                                                        <p className="text-sm font-medium text-slate-800">Weekly Report Ready</p>
                                                        <p className="text-xs text-slate-500 mt-1">Your productivity analysis for last week is available.</p>
                                                        <p className="text-[10px] text-slate-400 mt-1">Yesterday</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    {/* Mobile Only Profile Button */}
                                    <div className="relative lg:hidden">
                                        <button onClick={() => setIsProfileOpen(!isProfileOpen)} className="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-indigo-300 to-purple-300 border-2 border-white shadow-md flex items-center justify-center hover:shadow-lg transition-all">
                                            {!isProfileOpen && <span className="sr-only">Open Profile</span>}
                                        </button>
                                        {isProfileOpen && (
                                            <div className="absolute right-0 top-12 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 animate-in fade-in slide-in-from-top-2 z-[60]">
                                                <div className="px-4 py-2 border-b border-slate-50 mb-1">
                                                    <p className="text-sm font-bold text-slate-800">{profileData.name}</p>
                                                    <p className="text-xs text-slate-400">{profileData.email}</p>
                                                </div>
                                                <button onClick={() => { setIsProfileOpen(false); setIsEditProfileModalOpen(true); }} className="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2"><User size={16} /> Edit Profile</button>
                                                <button onClick={() => { setIsProfileOpen(false); setActiveTab('settings'); }} className="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2"><Settings size={16} /> Settings</button>
                                                <button className="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50 flex items-center gap-2"><LogOut size={16} /> Logout</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </header>
                        )}

                        {/* Background Watermark */}
                        <div className="absolute inset-0 z-0 flex items-center justify-center pointer-events-none overflow-hidden">
                            <span className="text-[18vw] font-bold text-[var(--primary)] opacity-[0.08] select-none -rotate-12 transform origin-center whitespace-nowrap">
                                {currentDate.toLocaleDateString('en-US', { weekday: 'long' })}
                            </span>
                        </div>

                        {/* Dashboard Content Container */}
                        <div 
                            ref={scrollContainerRef}
                            className="flex-1 overflow-y-auto p-4 lg:p-8 custom-scrollbar relative z-10 pb-32 lg:pb-8"
                        >
                            <div className="max-w-7xl mx-auto space-y-6 md:space-y-8 h-full">
                                {renderContent()}
                            </div>
                        </div>
                    </main>

                    {/* Add Habit Modal */}
                    <Modal isOpen={isHabitModalOpen} onClose={() => setIsHabitModalOpen(false)} title="Add New Habit">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Habit Name</label>
                                <input type="text" placeholder="e.g., Read for 15 mins" value={newHabit.name} onChange={(e) => setNewHabit({...newHabit, name: e.target.value})} className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Category</label>
                                <div className="flex gap-2">
                                    {['Health', 'Mind', 'Body', 'Growth'].map(cat => (
                                        <button key={cat} onClick={() => setNewHabit({...newHabit, category: cat})} className={`px-3 py-1.5 rounded-lg text-sm border transition-all ${newHabit.category === cat ? 'bg-emerald-100 border-emerald-500 text-emerald-800' : 'border-slate-200 text-slate-500 hover:border-emerald-200'}`}>{cat}</button>
                                    ))}
                                </div>
                            </div>
                            <button onClick={addHabit} className="w-full bg-[var(--primary)] text-white py-3 rounded-xl font-bold hover:bg-[var(--secondary)] transition-all mt-4 shadow-lg shadow-emerald-900/10">Create Habit</button>
                        </div>
                    </Modal>

                    {/* Add Task Modal */}
                    <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title="Add New Task">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Task Title</label>
                                <input type="text" placeholder="e.g., Submit monthly report" value={newTask.title} onChange={(e) => setNewTask({...newTask, title: e.target.value})} className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                                    <select value={newTask.priority} onChange={(e) => setNewTask({...newTask, priority: e.target.value})} className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 bg-white">
                                        <option>Low</option><option>Medium</option><option>High</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                                    <select value={newTask.due} onChange={(e) => setNewTask({...newTask, due: e.target.value})} className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 bg-white">
                                        <option>Today</option><option>Tomorrow</option><option>This Week</option>
                                    </select>
                                </div>
                            </div>
                            <button onClick={addTask} className="w-full bg-[var(--primary)] text-white py-3 rounded-xl font-bold hover:bg-[var(--secondary)] transition-all mt-4 shadow-lg shadow-emerald-900/10">Add Task</button>
                        </div>
                    </Modal>

                    {/* AI Smart Plan Modal */}
                    <Modal isOpen={isAIPlanModalOpen} onClose={() => setIsAIPlanModalOpen(false)} title="✨ Smart Plan">
                        <div className="space-y-4">
                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 mb-4">
                                <p className="text-sm text-purple-800 flex gap-2">
                                    <Sparkles size={18} className="shrink-0" />
                                    Tell AI your goal, and it will create a step-by-step plan for you.
                                </p>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">What is your goal?</label>
                                <input 
                                    type="text" 
                                    placeholder="e.g., Learn ReactJS in a week" 
                                    value={aiGoal} 
                                    onChange={(e) => setAiGoal(e.target.value)} 
                                    className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500/50" 
                                />
                            </div>
                            <button 
                                onClick={handleSmartPlan} 
                                disabled={isAILoading}
                                className={`w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all mt-4 flex items-center justify-center gap-2 ${isAILoading ? 'opacity-70 cursor-not-allowed' : ''}`}
                            >
                                {isAILoading ? (
                                    <>
                                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                        Generating Plan...
                                    </>
                                ) : (
                                    <>
                                        <Sparkles size={18} /> Generate Plan
                                    </>
                                )}
                            </button>
                        </div>
                    </Modal>

                    {/* AI Quiz Modal */}
                    <Modal isOpen={isQuizModalOpen} onClose={() => setIsQuizModalOpen(false)} title="✨ AI Quiz Master">
                        <div className="space-y-4">
                            {quizContent?.loading ? (
                                <div className="flex flex-col items-center justify-center py-8">
                                    <div className="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
                                    <p className="text-slate-500 animate-pulse">Consulting the AI Tutor...</p>
                                </div>
                            ) : (
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 whitespace-pre-wrap font-mono text-sm text-slate-700 max-h-96 overflow-y-auto">
                                    {quizContent?.text}
                                </div>
                            )}
                            {!quizContent?.loading && (
                                <button onClick={() => setIsQuizModalOpen(false)} className="w-full bg-slate-200 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-300 transition-all mt-4">Close Quiz</button>
                            )}
                        </div>
                    </Modal>

                    {/* Edit Profile Modal */}
                    <Modal isOpen={isEditProfileModalOpen} onClose={() => setIsEditProfileModalOpen(false)} title="Edit Profile">
                        <div className="space-y-4">
                            <div className="flex justify-center mb-6">
                                <div className="relative">
                                    <div className="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-300 to-purple-300 border-4 border-white shadow-lg flex items-center justify-center text-3xl text-white font-bold overflow-hidden">
                                        {profileImage ? (
                                            <img src={profileImage} alt="Profile" className="w-full h-full object-cover" />
                                        ) : (
                                            profileData.name.charAt(0)
                                        )}
                                    </div>
                                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                                    <button onClick={() => fileInputRef.current.click()} className="absolute bottom-0 right-0 p-2 bg-slate-800 text-white rounded-full shadow-md hover:bg-slate-700"><ImageIcon size={14}/></button>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                                <input type="text" value={profileData.name} onChange={(e) => setProfileData({...profileData, name: e.target.value})} className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Email</label>
                                <input type="email" value={profileData.email} onChange={(e) => setProfileData({...profileData, email: e.target.value})} className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Bio / Title</label>
                                <input type="text" value={profileData.bio} onChange={(e) => setProfileData({...profileData, bio: e.target.value})} className="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50" />
                            </div>
                            <button onClick={() => setIsEditProfileModalOpen(false)} className="w-full bg-[var(--primary)] text-white py-3 rounded-xl font-bold hover:bg-[var(--secondary)] transition-all mt-4 shadow-lg shadow-emerald-900/10">Save Changes</button>
                        </div>
                    </Modal>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
